#!/bin/sh
# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by scripts/Create-CopyPatch.
# 
# T2 SDE: target/share/livecd/init
# Copyright (C) 2020 The T2 SDE Project
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- T2-COPYRIGHT-NOTE-END ---


live="live=live.squash `cat /proc/cmdline`" ; live=${live##*live=} ; live=${live%% *}
echo "Searching for media with $live image ..."
mkdir -p /{media,mnt}/live
i=0
while [ $i -le 14 ]; do
  for x in /sys/block/*/device; do
    x=${x%/device}; x=${x#/sys/block/}
    [ "$x" = "*" ] && continue
    # TODO: make option to skip fixed devices
    #case "`ls -l /sys/block/$x/device`" in 
    #  */usb*|*/ieee1394) : ;;
    #  *) [ "`cat /sys/block/$x/removable`" = 1 ] || continue ;;
    #esac
    x=/dev/$x
    for x in ${x}* ; do
      [ -e $x ] || continue
      fs=`disktype $x 2>/dev/null |
          sed -e '/file system/!d' -e 's/file system.*//' -e 's/ //g' \
              -e 'y/ABCDEFGHIJKLMNOPQRSTUVWXYZ/abcdefghijklmnopqrstuvwxyz/' \
              -e 's/fat.*/vfat/' | sed -n '$p'`
      [ $i -gt 2 ] && echo "Testing device $x, type $fs ..."
      if mount -t $fs -o ro $x /media/live 2>/dev/null; then
	[ $i -gt 0 ] && echo "Successfully mounted $x ..."
	if [ -f /media/live/$live ]; then
	  echo "Found the $live image on $x."

	  if losetup /dev/loop0 /media/live/$live &&
	     mount -t squashfs -o ro /dev/loop0 /mnt/live
	  then
	    kill %1

	    # setup final directory structure
	    mkdir -p /tmp/bin
	    mv /lib /tmp/
	    mv /bin/* /sbin/* /tmp/bin/
	    for x in /mnt/live/* ; do
		x=${x#/mnt/live/}
		case $x in
		  dev|proc|sys|media|mnt|tmp) continue ;;
		esac
		if [ -e /$x ]; then
#			echo "Removing /$x ..."
			/tmp/bin/rm -rf /$x
		fi
#		echo "Sym-linking /mnt/live/$x /$x"
		/tmp/bin/ln -s /mnt/live/$x /$x
	    done

#	    /tmp/bin/ls -l / /tmp
#	    /tmp/bin/rm -rf /tmp/bin

	    exec /init2 $*
	  else
	    echo "Failed to loop-mount $live."
	    losetup -d /dev/loop0
	  fi
	else
	  echo "No $live image found."
	fi
	umount /media/live
      fi
    done
  done
  : $(( i++ ))
  sleep 1
done

echo "No live media found, giving up. Debug shell:"
exec /bin/sh

#!patch

Do only bind to the loopback interface by default, so we do not open the port
to the public, are only able to send mail out and only accept local users with a
.forward file (so only the mail user, e.g. not archivista nor root) and no
system aliases.

Furthermore (for best user experience) only try remote smtp if the domain
resolved and try a local delivery (we only have a valid user mail) instead
so people do not need any setup and can just send mail the the IP or name
they configured in their existing, local network.

  - Rene Rebe <rene@exactcode.de>

--- configure.orig	2005-10-30 06:26:08.000000000 +0100
+++ configure	2005-12-08 16:52:01.000000000 +0100
@@ -239,7 +239,7 @@
 
 timeout_frozen_after = 7d
 
-
+local_interfaces = 127.0.0.1
 
 ######################################################################
 #                       ACL CONFIGURATION                            #
@@ -432,8 +437,7 @@
   driver = dnslookup
   domains = ! +local_domains
   transport = remote_smtp
-  ignore_target_hosts = 0.0.0.0 : 127.0.0.0/8
-  no_more
+  ignore_target_hosts = 0.0.0.0 : 127.0.0.0/8 : @[]


 # The remaining routers handle addresses in the local domain(s).
@@ -459,14 +460,14 @@
 # listed below are the same as are used for .forward files; you might want
 # to set up different ones for pipe and file deliveries from aliases.
 
-system_aliases:
-  driver = redirect
-  allow_fail
-  allow_defer
-  data = ${lookup{$local_part}lsearch{/etc/aliases}}
-# user = exim
-  file_transport = address_file
-  pipe_transport = address_pipe
+#system_aliases:
+#  driver = redirect
+#  allow_fail
+#  allow_defer
+#  data = ${lookup{$local_part}lsearch{/etc/aliases}}
+## user = exim
+#  file_transport = address_file
+#  pipe_transport = address_pipe
 
 
 # This router handles forwarding using traditional .forward files in users'
@@ -500,13 +501,13 @@
 # local_part_suffix_optional
   file = $home/.forward
 # allow_filter
-  no_verify
-  no_expn
+#  no_verify
+#  no_expn
   check_ancestor
   file_transport = address_file
   pipe_transport = address_pipe
   reply_transport = address_reply
-
+  directory_transport = address_dictonary
 
 # This router matches local user mailboxes. If the router fails, the error
 # message is "Unknown user".
@@ -516,13 +517,13 @@
 # part_suffix options. Then, for example, xxxx-foo@your.domain will be treated
 # in the same way as xxxx@your.domain by this router.
 
-localuser:
-  driver = accept
-  check_local_user
-# local_part_suffix = +* : -*
-# local_part_suffix_optional
-  transport = local_delivery
-  cannot_route_message = Unknown user
+#localuser:
+#  driver = accept
+#  check_local_user
+## local_part_suffix = +* : -*
+## local_part_suffix_optional
+#  transport = local_delivery
+#  cannot_route_message = Unknown user
 
 
 
@@ -584,6 +585,13 @@
   envelope_to_add
   return_path_add
 
+address_dictonary:
+  driver = appendfile
+	maildir_format = true
+	delivery_date_add
+	envelope_to_add
+	return_path_add
+
 
 # This transport is used for handling autoreplies generated by the filtering
 # option of the userforward router.

#!/bin/bash
#
# --- ROCK-COPYRIGHT-NOTE-BEGIN ---
#
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# Please add additional copyright information _after_ the line containing
# the ROCK-COPYRIGHT-NOTE-END tag. Otherwise it might get removed by
# the ./scripts/Create-CopyPatch script. Do not edit this copyright text!
#
# ROCK Linux: rock-src/scripts/Build-Pkg
# ROCK Linux is Copyright (C) 1998 - 2003 Clifford Wolf
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version. A copy of the GNU General Public
# License can be found at Documentation/COPYING.
#
# Many people helped and are helping developing ROCK Linux. Please
# have a look at http://www.rocklinux.org/ and the Documentation/TEAM
# file for details.
#
# --- ROCK-COPYRIGHT-NOTE-END ---

#
# bless-rs6k is Copyright (C) 2003 Rene Rebe
#

# $1: disk base dir
# $2: cd number
# $3: iso file

yb_bin="${1}/boot/yaboot.rs6k"
cd=$2
iso=$3

# function to return a 512 sized sector count
sector_count() {
	echo `du -B 512 --apparent-size $1 | -d ' ' -f1` 
}

if [ "$cd" == 0 ] ; then
	echo "Not the first CD - not blessing ..."
fi


# test
cd_sec=`sector_count $iso`

# calculate the size for a 512 byte alligned yaboot binary, padded with zeros
yb_sec=`sector_count $yb_bin`
yb_sec=$(( yb_sec + 1 ))

echo "ISO sector count: $cd_sec Yaboot RS/6k binary sectors: $yb_sec"

echo "RS/6k-blessing $iso ..."
sfdisk -uS -f -q --no-reread $iso <<-EOT
;
$cd_sec,$yb_sec,0x41,*
;
;
EOT

echo "done"

echo "Attaching Yaboot binary with padded zeros ..."
cat $yb_bin /dev/zero | dd bs=512 count=$yb_sec >> $iso 


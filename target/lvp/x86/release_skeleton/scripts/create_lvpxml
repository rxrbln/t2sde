#!/bin/bash

usage_create_lvpxml() {
	echo -n
}

process_create_lvpxml() {
	unset files
	unset title
	for x in `printenv | grep ^file_ | cut -f1 -d=` ; do
		[ ! -z "${files}" ] && files="${files}\n"
		files="${files}${x}"
		[ -z "${title}" ] && eval "title=\${${x}}"
	done
	title=${title##*/}
	title=${title%% -*}

	files=`echo -e ${files} | sort`

	rm -f ${lvpxml}
	touch ${lvpxml}

	echo "Creating lvp.xml file"
	read -p "Enter title of this LVP [${title}]: " tmp
	[ ! -z "${tmp}" ] && title="${tmp}"

	cat > ${lvpxml} << EOF
<lvp>
	<item type="text">
		<position x="0" y="90">
		<size w="5" h="5">
		<text>${title}</text>
	</item>
EOF

	item=0
	for file in ${files} ; do
		eval "file=\${${file}}" # dereference the variable to get the real file
		button_text=${file%.*}
		button_text=${button_text##*- }
		read -p "Enter button text for ${file} [${button_text}]: " tmp
		[ ! -z "${tmp}" ] && button_text=${tmp}
		cat >> ${lvpxml} << EOF
	<item type="button">
		<position x="$(( (${item} % 4) * 50 - 75 ))" y="$(( 80 - ((${item} - (${item} % 4)) / 4) * 15))" />
		<action>/usr/bin/mplayer -fs -zoom ${mplayer_param} '${file}'</action>
		<size w="40" h="10" />
		<text>${button_text}</text>
	</item>
EOF
# a little "special" for multi-language anime
#if [ "${file##*.}" == "ogm" ] ; then
#cat >> ${lvpxml} << EOF
#<item type="button">
#<position x="$(( (${item} % 4) * 50 - 75 ))" y="$(( 80 - ((${item} - (${item} % 4)) / 4) * 15 - 7))" />
#<action>/usr/bin/mplayer -aid 2 -sid 3 -fs -zoom '${file}'</action>
#<size w="40" h="4" />
#<text>jap</text>
#</item>
#EOF
#fi
		item=$(( ${item} + 1 ))
	done
	echo "</lvp>" >> ${lvpxml}

	echo "done creating lvp.xml file"
	echo "Please check that the file is correct!"

	if [ ! -z ${DISPLAY} ] ; then
		echo "Trying to show menu now on ${DISPLAY}"
		lvp=`which lvp`
		[ -z "${lvp}" ] && lvp="livesystem/usr/bin/lvp"
		if ! test -x ${lvp} ; then
			echo "Can't execute ${lvp}... this doesn't look good..."
		else
			${lvp} ${lvpxml}
		fi
	fi
}

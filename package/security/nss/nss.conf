# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# T2 SDE: package/.../nss/nss.conf
# Copyright (C) 2008 The T2 SDE Project
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- T2-COPYRIGHT-NOTE-END ---

libdir=$libdir/nss
includedir=$includedir/nss

pkgprefix -t nspr

nss_build ()
{
	# fixup nspr include path
	echo "INCLUDES += -I/$(pkgprefix includedir nspr) -I/usr/include/dbm" >> mozilla/security/coreconf/headers.mk

	# 64Bit
	[[ $libdir = *lib64 ]] && export USE_64=1

	# build

	var_remove_regex makeopt ' ' '-j.'

	export NSDISTMODE=copy
	export NSS_USE_SYSTEM_SQLITE=1

	eval make -C mozilla/security/coreconf $makeopt BUILD_OPT=1
	eval make -C mozilla/security/dbm $makeopt BUILD_OPT=1
	eval make -C mozilla/security/nss $makeopt BUILD_OPT=1 NSPR_LIB_DIR=$(pkgprefix libdir nspr)

	# install

	(
	# copy libs and header files
	cd mozilla/dist
	cp -L */lib/*.so $root$libdir
	cp -L */lib/*.chk $root$libdir
	cp -L */lib/*.a $root$libdir
	cp -L private/nss/*.h $root$includedir
	cp -L public/nss/*.h $root$includedir

	# create symlinks to shared nss libs
	cd $root$libdir
	for file in *.so; do
		mv ${file} ${file}.${ver}
		ln -s ${file}.${ver} ${file}
		ln -s nss/${file}.${ver} $root/usr/lib/${file}
	done
	)

	cp $confdir/nss-config.in ${root}${bindir}/nss-config
	cp $confdir/nss.pc.in ${root}$(pkgprefix libdir pkgconfig)/pkgconfig/nss.pc
	chmod 755 ${root}${bindir}/nss-config
	chmod 644 ${root}$(pkgprefix libdir pkgconfig)/pkgconfig/nss.pc

	NSS_VMAJOR=`cat mozilla/security/nss/lib/nss/nss.h | grep "#define.*NSS_VMAJOR" | awk '{print $3}'`
	NSS_VMINOR=`cat mozilla/security/nss/lib/nss/nss.h | grep "#define.*NSS_VMINOR" | awk '{print $3}'`
	NSS_VPATCH=`cat mozilla/security/nss/lib/nss/nss.h | grep "#define.*NSS_VPATCH" | awk '{print $3}'`

	sed -e "s,@libdir@,$libdir,g" \
		-e "s,@prefix@,/$prefix,g" \
		-e "s,@exec_prefix@,\$\{prefix},g" \
		-e "s,@includedir@,\$\{prefix}/include/nss,g" \
		-e "s,@MOD_MAJOR_VERSION@,$NSS_VMAJOR,g" \
		-e "s,@MOD_MINOR_VERSION@,$NSS_VMINOR,g" \
		-e "s,@MOD_PATCH_VERSION@,$NSS_VPATCH,g" \
		-i ${root}${bindir}/nss-config

	sed -e "s,@libdir@,$libdir,g" \
	      -e "s,@prefix@,/$prefix,g" \
	      -e "s,@exec_prefix@,\$\{prefix},g" \
	      -e "s,@includedir@,\$\{prefix}/include/nss," \
	      -e "s,@NSPR_VERSION@,`nspr-config --version`,g" \
	      -e "s,@NSS_VERSION@,$NSS_VMAJOR.$NSS_VMINOR.$NSS_VPATCH,g" \
	      -i ${root}$(pkgprefix libdir pkgconfig)/pkgconfig/nss.pc

	echo "NSS utils not installed: `ls mozilla/dist/*/bin`"
}
custmain=nss_build

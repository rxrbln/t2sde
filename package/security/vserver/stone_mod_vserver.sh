#!/bin/sh
# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# T2 SDE: package/.../vserver/stone_mod_vserver.sh
# Copyright (C) 2004 - 2005 The T2 SDE Project
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- T2-COPYRIGHT-NOTE-END ---
# [MAIN] 40 vserver Linux VServer Manager

CONFDIR=/etc/vservers

oneliner() {
	[ -r $1 ] && head -n 1 $1 || echo "N/A"
}

gui_edit_oneliner() {
	local value=
	[ -f $2 ] && value="$( cat $2 )"
	if gui_input "Enter value for '$1' ($2):" "$value" value; then
		if [ "$value" ]; then
			echo "$value" > $2
		else
			rm -f $2
		fi
	fi
}
gui_edit_deleteable() {
	gui_edit $1 $2
	[ ! -s $2 ] && rm -f $2
}

vserver_conf_manage() {
	local server="$1" errno=0

	while [ $errno -eq 0 ]; do
		local options=
		
		options="$options 'Name ......: $( oneliner $CONFDIR/$server/name )' ''"
		options="$options 'XID .......: $( oneliner $CONFDIR/$server/run )' ''"
		options="$options 'Directory .: $( readlink -f $CONFDIR/$server/vdir )' ''"
		options="$options 'Context ...: $( oneliner $CONFDIR/$server/context )' \
			'gui_edit_oneliner context $CONFDIR/$server/context'"
		options="$options 'Namespace .: $( oneliner $CONFDIR/$server/namespace )' \
			'gui_edit_oneliner namespace $CONFDIR/$server/namespace'"
			
		options="$options '' ''"
		case "`uname -r`" in
			2.4*)	options="$options 'System Capabilities' \
					'gui_edit_deleteable capabilities $CONFDIR/$server/capabilities'"
				;;
			*)	options="$options 'System Capabilities' \
					'gui_edit_deleteable bcapabilities $CONFDIR/$server/bcapabilities'"
				;;
		esac
		options="$options 'Context Capabilities' \
			'gui_edit_deleteable ccapabilities $CONFDIR/$server/ccapabilities'"
		options="$options 'Flags' \
			'gui_edit_deleteable flags $CONFDIR/$server/flags'"
		options="$options 'Personalities' \
			'gui_edit_deleteable personality $CONFDIR/$server/personality'"
		options="$options 'Scheduler Parameters' \
			'gui_edit_deleteable schedule $CONFDIR/$server/schedule'"

		options="$options '' ''"
		options="$options 'Nice Level ...: $( oneliner $CONFDIR/$server/nice )' \
			'gui_edit_oneliner nice $CONFDIR/$server/nice'"
		options="$options 'Default Shell : $( oneliner $CONFDIR/$server/shell )' \
			'gui_edit_oneliner shell $CONFDIR/$server/shell'"

		options="$options '' ''"
		options="$options 'fstab' \
			'gui_edit fstab $CONFDIR/$server/fstab'"
		options="$options 'fstab.remote' \
			'gui_edit fstab_remote $CONFDIR/$server/fstab.remote'"

		eval "gui_menu vserver_conf 'VServer \`$server\` Configuration' $options"
		errno=$?
	done
}

vserver_new() {
	local server= action= errno=
	gui_input "Enter a name for the new vserver" '' server
	if [ "$server" ]; then
		action="vserver '$server' build -m skeleton"
		eval "$action"; errno=$?
		if [ $errno -eq 0 ]; then
			vserver_conf_manage "$server"
		else
			gui_message "\"$action\" failed."
		fi
	fi
}


main() {
	local errno=0
	local servers= server=

	while [ $errno -eq 0 ]; do
		servers=
		for server in $( ls -1 $CONFDIR); do
			[ -d $CONFDIR/$server ] && servers="$servers 'vserver: $server' 'vserver_conf_manage $server'"
		done

		[ "$servers" ] && servers="$servers '' ''"
		eval "gui_menu vserver 'Linux VServer Manager' $servers 'Create a new vserver' 'vserver_new'"
		errno=$?
	done
}

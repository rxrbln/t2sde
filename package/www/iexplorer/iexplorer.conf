# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# T2 SDE: package/.../iexplorer/iexplorer.conf
# Copyright (C) 2006 The T2 SDE Project
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.

autoextract=0
makeopt=
makeinstopt=

datadir=$datadir/$pkg
tmpdir=$builddir/tmp

function createShortcuts() {
	cat <<-EOT > $bindir/$1
	#!/bin/bash
	cd $HOME
	export WINEPREFIX="$datadir/$1"
	exec wine "$datadir/$1/drive_c/Program Files/Internet Explorer/IEXPLORE.EXE" \$@
	EOT
	chmod +x $bindir/$1

	cat <<-EOT > $docdir/$1.desktop
	Exec "$bindir/$1"
	Icon "$docdir/ie_wine.svg"
	Name "Internet Explorer $2"
	GenericName "Microsoft Windows Aplication"
	Comment "Microsoft Internet Explorer on Linux"
	EOT
}

do_basic_installation() {
	local SYSTEMDRIVE="$datadir/base/drive_c"
	local SYSTEMDIR="$SYSTEMDRIVE/windows/system"

	echo "Creating basic Windows installation"
	export WINEPREFIX="$datadir/base"

	mkdir -p "$WINEPREFIX"

	echo "Creating Wine Prefix"
	xvfb-run wineprefixcreate > /dev/null

	mkdir -p "$SYSTEMDRIVE/Program Files/Internet Explorer"
	cd $tmpdir

	# Install riched.dll
	echo "Installing RICHED20"
	cabextract -q -F ver1200.exe `match_source_file -p 249973USA8`
	cabextract -q -F riched20.120 $tmpdir/ver1200.exe
	mv -v riched20.120 $SYSTEMDIR/riched20.dll

	# Install DCOM98
	echo "Installing DCOM98"
	cabextract -q -d "$SYSTEMDIR" `match_source_file -p DCOM98`
	mv -v "$SYSTEMDIR/dcom98.inf" "$SYSTEMDIR/../inf/"

	# Install mfc40
	echo "Installing ActiveX MFC40"
	cabextract -q `match_source_file -p mfc40`
	cabextract -q -F "mfc40.dll" mfc40.exe
	mv -v mfc40.dll $SYSTEMDIR/

	# last things
	echo "Finalizing"
	cp -v "$confdir/ie_wine.svg" "$docdir/ie_wine.svg"
}

hook_add postmake 9 "rm -rf '$tmpdir' '$datadir/base'"

# Installations functions
function new_installation() {
        rm -rf "$datadir/$1"
        cp -r "$datadir/base" "$datadir/$1"
}

hook_add premake 4 'mkdir -p $tmpdir $datadir/base'
hook_add premake 5 'do_basic_installation'

hook_add postmake 5 'install_ie6'
install_ie6() {
	local SYSTEMDRIVE="$datadir/ie6/drive_c"
	local SYSTEMDIR="$SYSTEMDRIVE/windows/system"

	cd $tmpdir
	new_installation ie6

	echo "Extracting downloaded exe file"
	wine `match_source_file -p ie60`
	cd IE*

	echo "Extracting CAB files"
	cabextract -q IE_S*CAB
	cabextract -q -L -d $SYSTEMDIR/ IE_1.CAB IEDOM.CAB
	mv -v $SYSTEMDIR/{sch128c,schannel}.dll
	mv -v $SYSTEMDIR/iexplore.exe "$SYSTEMDRIVE/Program Files/Internet Explorer/IEXPLORE.EXE"

	cabextract -q -L -d $SYSTEMDIR SCR56EN.CAB
	cabextract -q -L -F "pngfilt.dll" ADVAUTH.CAB
	cabextract -q -L -F "msvcrt.dll" SETUPW95.CAB
	mv -v pngfilt.dll msvcrt.dll $SYSTEMDIR

	echo "Installing TTF Fonts"
	cabextract -q -L -F "*TTF" FONT*CAB
	mv -v *ttf $SYSTEMDIR/../fonts/

	echo "Configuring ie6"
	gunzip -c $confdir/winereg.system.reg.gz > $datadir/ie6/system.reg
	gunzip -c $confdir/winereg.user.reg > $datadir/ie6/user.reg

	createShortcuts ie6 6.0

        rm -rf $tmpdir/*
}

hook_add postmake 5 'install_flash'
install_flash() {
	echo "Installing Flash Player 8"
	echo "Preparing installation"

	cd $tmpdir

	# Copy Flash files
	cabextract -q -d $tmpdir `match_source_file -p swflash`

	# Create add.reg
	sed -n -e 's/^\[/;\[/g;/^;\[SW.AddReg\]/,/^;\[/p;' swflash.inf > add.reg2
	sed '/^;/ d;/^\s/ d' add.reg2 > add.reg

	strings=` sed -n -e 's/\s//g;s/^\[/;\[/g;/^;\[strings\]/,/^;\[/p;/^;/d;/^\s/d' swflash.inf `
	for string in $strings; do
        	key=` echo $string | awk -F '=' '/^[^;]/ {print $1}' `
		value=` echo $string | awk -F '"' '/^[^;]/ {print $2}' | sed -e 's/\//BARRA/g '`

	        sed -e "s/%${key}%/${value}/g;s/BARRA/\//g" add.reg > add.reg2
	        mv add.reg2 add.reg
	done
        install_flash_player ie6
}

# Function that installs Flash Player on a IE
install_flash_player() {
	local SYSTEMDIR="$datadir/$1/drive_c/windows/system"
	export WINEPREFIX="$datadir/$1/"
	cd $tmpdir

        mkdir -p "$SYSTEMDIR/Macromed/Flash/"
        cp -v GetFlash.exe Flash8a.ocx "$SYSTEMDIR/Macromed/Flash/"
        wine regedit "$tmpdir/add.reg"
        wine regsvr32 'C:\Windows\System\Macromed\Flash\Flash8a.ocx'
}


# --- T2-COPYRIGHT-BEGIN ---
# t2/package/*/llama-cpp/opencl-amd.patch
# Copyright (C) 2025 - 2026 The T2 SDE Project
# SPDX-License-Identifier: GPL-2.0 or patched project license
# --- T2-COPYRIGHT-END ---

--- ./ggml/src/ggml-opencl/ggml-opencl.cpp.orig	2000-01-01 01:00:00.000000000 +0100
+++ ./ggml/src/ggml-opencl/ggml-opencl.cpp	2026-01-27 12:51:16.500753849 +0100
@@ -86,6 +86,7 @@
 
 enum GPU_FAMILY {
     ADRENO,
+    AMD,
     INTEL,
     UNKNOWN,
 };
@@ -2606,6 +2607,8 @@
         backend_ctx->adreno_wave_size = 64;
     } else if (strstr(dev_ctx->device_name.c_str(), "Intel")) {
         backend_ctx->gpu_family = GPU_FAMILY::INTEL;
+    } else if (strstr(dev_ctx->device_name.c_str(), "AMD")) {
+        backend_ctx->gpu_family = GPU_FAMILY::AMD;
     } else {
         GGML_LOG_ERROR("Unsupported GPU: %s\n", dev_ctx->device_name.c_str());
         backend_ctx->gpu_family = GPU_FAMILY::UNKNOWN;
@@ -6490,6 +6493,8 @@
     //    sizeof(size_t), &sgs, NULL));
     if (backend_ctx->gpu_family == ADRENO) {
         sgs = 64;
+    } else if (backend_ctx->gpu_family == AMD) {
+        sgs = 64;
     } else if (backend_ctx->gpu_family == INTEL) {
         sgs = 32;
     } else {
@@ -6577,6 +6582,8 @@
     size_t sgs;
     if (backend_ctx->gpu_family == ADRENO) {
         sgs = 64;
+    } else if (backend_ctx->gpu_family == AMD) {
+        sgs = 64;
     } else if (backend_ctx->gpu_family == INTEL) {
         sgs = 32;
     } else {
@@ -6658,6 +6665,7 @@
 
     size_t sgs;
     if (backend_ctx->gpu_family == ADRENO) sgs = 64;
+    else if (backend_ctx->gpu_family == AMD) sgs = 64;
     else if (backend_ctx->gpu_family == INTEL) sgs = 32;
     else GGML_ASSERT(false && "Unsupported GPU");
 
@@ -6789,6 +6797,8 @@
     size_t sgs = 64;
     if (backend_ctx->gpu_family == ADRENO) {
         sgs = 64;
+    } else if (backend_ctx->gpu_family == AMD) {
+        sgs = 64;
     } else if (backend_ctx->gpu_family == INTEL) {
         sgs = 32;
     } else {
@@ -8553,6 +8563,11 @@
                     nth1 = 1;
 
                     kernel = backend_ctx->kernel_mul_mat_q4_0_f32_1d_16x_flat;
+		} else if (backend_ctx->gpu_family == AMD) {
+                    nth0 = 16;
+                    nth1 = 1;
+
+                    kernel = backend_ctx->kernel_mul_mat_q4_0_f32_1d_16x_flat;
                 } else if (backend_ctx->gpu_family == ADRENO) {
                     nth0 = 64;
                     nth1 = 1;
@@ -8592,6 +8607,11 @@
                 global_work_size[0] = (size_t)(ne01 + 15)/16*nth0;
                 global_work_size[1] = (size_t)ne11*nth1;
                 global_work_size[2] = (size_t)ne12*ne13;
+            } else if (backend_ctx->gpu_family == AMD) {
+                // Set global size for AMD. It uses 16x output values.
+                global_work_size[0] = (size_t)(ne01 + 15)/16*nth0;
+                global_work_size[1] = (size_t)ne11*nth1;
+                global_work_size[2] = (size_t)ne12*ne13;
             }
 
             backend_ctx->enqueue_ndrange_kernel(kernel, 3, global_work_size, local_work_size, dst);
@@ -8613,6 +8633,9 @@
             if (backend_ctx->gpu_family == INTEL) {
                 nth0 = 32;
                 nth1 = 1;
+            } else if (backend_ctx->gpu_family == AMD) {
+                nth0 = 32;
+                nth1 = 1;
             } else if (backend_ctx->gpu_family == ADRENO) {
                 nth0 = 64;
                 nth1 = 1;
@@ -8650,6 +8673,9 @@
             if (backend_ctx->gpu_family == INTEL) {
                 nth0 = 32;
                 nth1 = 1;
+            } else if (backend_ctx->gpu_family == AMD) {
+                nth0 = 32;
+                nth1 = 1;
             } else if (backend_ctx->gpu_family == ADRENO) {
                 nth0 = 64;
                 nth1 = 1;
@@ -8709,6 +8735,12 @@
 
                 kernel = backend_ctx->kernel_mul_mat_q4_0_f32_8x_flat;
                 ndst = 8;
+            } else if (backend_ctx->gpu_family == AMD) {
+                nth0 = 16;
+                nth1 = 1;
+
+                kernel = backend_ctx->kernel_mul_mat_q4_0_f32_8x_flat;
+                ndst = 8;
             } else if (backend_ctx->gpu_family == ADRENO) {
                 nth0 = 64;
                 nth1 = 1;
@@ -8745,6 +8777,16 @@
 
                 kernel = backend_ctx->kernel_mul_mat_q4_0_f32;
                 ndst = 4;
+            } else if (backend_ctx->gpu_family == AMD) {
+                // Use 1D local size. Each workgroup is a SIMD group. Each SIMD
+                // group produces N_DST (4 for Q4_0 kernel) values in the result.
+                // The number of workgroups on dim 0 (the leading dimension) is
+                // the nearest multiple of 4 that covers ne0 (equals ne01).
+                nth0 = 16;
+                nth1 = 1;
+
+                kernel = backend_ctx->kernel_mul_mat_q4_0_f32;
+                ndst = 4;
             } else if (backend_ctx->gpu_family == ADRENO) {
                 nth0 = 64;
                 nth1 = 1;
@@ -8784,6 +8826,10 @@
                 nth0 = 16;
                 nth1 = 2;
                 ndst = nth1*4;
+	    } else if (backend_ctx->gpu_family == AMD) {
+                nth0 = 16;
+                nth1 = 2;
+                ndst = nth1*4;
             } else if (backend_ctx->gpu_family == ADRENO) {
                 nth0 = 64;
                 nth1 = 2;
@@ -8821,6 +8867,10 @@
                 nth0 = 16;
                 nth1 = 2;
                 ndst = nth1*4;
+	    } else  if (backend_ctx->gpu_family == AMD) {
+                nth0 = 16;
+                nth1 = 2;
+                ndst = nth1*4;
             } else if (backend_ctx->gpu_family == ADRENO) {
                 nth0 = 64;
                 nth1 = 2;
@@ -8863,6 +8913,10 @@
                 nth0 = 16;
                 nth1 = 2;
                 ndst = 4;
+	    } else if (backend_ctx->gpu_family == AMD) {
+                nth0 = 16;
+                nth1 = 2;
+                ndst = 4;
             } else if (backend_ctx->gpu_family == ADRENO) {
                 nth0 = 64;
                 nth1 = 2;
@@ -8895,6 +8949,10 @@
                 nth0 = 16;
                 nth1 = 2;
                 ndst = 1;
+	    } else if (backend_ctx->gpu_family == AMD) {
+                nth0 = 16;
+                nth1 = 2;
+                ndst = 1;
             } else if (backend_ctx->gpu_family == ADRENO) {
                 nth0 = 64;
                 nth1 = 2;
@@ -8931,6 +8989,12 @@
                 ndst = nth1*2;
 
                 q = extra0_mxfp4->q;
+	    } else if (backend_ctx->gpu_family == AMD) {
+                nth0 = 16;
+                nth1 = 2;
+                ndst = nth1*2;
+
+                q = extra0_mxfp4->q;
             } else if (backend_ctx->gpu_family == ADRENO) {
                 nth0 = 64;
                 nth1 = 2;
@@ -8966,6 +9030,10 @@
                 nth0 = 16;
                 nth1 = 2;
                 ndst = nth1*2;
+	    } else if (backend_ctx->gpu_family == AMD) {
+                nth0 = 16;
+                nth1 = 2;
+                ndst = nth1*2;
             } else if (backend_ctx->gpu_family == ADRENO) {
                 nth0 = 64;
                 nth1 = 2;
@@ -9119,6 +9187,10 @@
                 sgs  = 16;
                 nsg  = 1;
                 ndst = 8;
+	    } else if (backend_ctx->gpu_family == AMD) {
+                sgs  = 16;
+                nsg  = 1;
+                ndst = 8;
             } else if (backend_ctx->gpu_family == ADRENO) {
                 sgs  = 64;
                 nsg  = 1;
@@ -9163,6 +9235,10 @@
                 sgs  = 16;
                 nsg  = 2;
                 ndst = 4;
+	    } else if (backend_ctx->gpu_family == AMD) {
+                sgs  = 16;
+                nsg  = 2;
+                ndst = 4;
             } else if (backend_ctx->gpu_family == ADRENO) {
                 sgs  = 64;
                 nsg  = 2;
@@ -9199,6 +9275,10 @@
                 sgs  = 16;
                 nsg  = 2;
                 ndst = 4;
+	    } else if (backend_ctx->gpu_family == AMD) {
+                sgs  = 16;
+                nsg  = 2;
+                ndst = 4;
             } else if (backend_ctx->gpu_family == ADRENO) {
                 sgs  = 64;
                 nsg  = 2;
@@ -9341,6 +9421,12 @@
                 ndst = 2;
 
                 q = extra0_mxfp4->q;
+	    } else if (backend_ctx->gpu_family == AMD) {
+                sgs  = 16;
+                nsg  = 2;
+                ndst = 2;
+
+                q = extra0_mxfp4->q;
             } else if (backend_ctx->gpu_family == ADRENO) {
                 sgs  = 64;
                 nsg  = 1;
@@ -9382,6 +9468,10 @@
                 sgs  = 16;
                 nsg  = 2;
                 ndst = 2;
+	    } else if (backend_ctx->gpu_family == AMD) {
+                sgs  = 16;
+                nsg  = 2;
+                ndst = 2;
             } else if (backend_ctx->gpu_family == ADRENO) {
                 sgs  = 64;
                 nsg  = 2;
@@ -9717,6 +9807,10 @@
         // This is the same as the initial value.
         nth = MIN(32, ne00);
     }
+    else if (backend_ctx->gpu_family == AMD) {
+        // This is the same as the initial value.
+        nth = MIN(32, ne00);
+    }
     else if (backend_ctx->gpu_family == ADRENO) {
         nth = 64;
     } else {

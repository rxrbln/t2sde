# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# T2 SDE: package/.../ooo/ooo.conf
# Copyright (C) 2004 - 2006 The T2 SDE Project
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- T2-COPYRIGHT-NOTE-END ---

if [ $prefix_auto = 1 ] ; then
	prefix=/opt/ooo
	set_confopt
fi

ooo_lang='en-US de es fr it' #ALL

############################################################################
# Ximian build system configuration options

var_append confopt ' ' "--with-installed-ooo-dirname=OpenOffice.org"

# src680-mXX
cvstag=$( match_source_file -core.tar )
var_append confopt ' ' "--with-tag=${cvstag%-core.tar*}"

# populate src/ with every [D] on our .desc
# (instead of --with-srcdir)
#
hook_add prepatch 5 'ooo_populate_src'
ooo_populate_src() {
	for i in `match_source_file -p .`; do
	  case "$i" in
		*lp_solve*)
			trg=`basename $i`
			trg=${trg/.bz2/.gz}
			bunzip2 -c $i | gzip --fast > src/$trg
			;;
		*)
			ln -svf $i src/
			;;
	  esac
	done
}

# instead of --with-internal-gcc
var_append confopt ' ' "--with-system-gcc"

# yes, we are ourselves
dist=T2
[ $arch_sizeof_char_p = 8 ] && dist=${dist}64
var_append confopt ' ' "--with-distro=$dist" 
var_append confopt ' ' "--with-vendor=$dist"

# UI language
var_append confopt ' ' "'--with-lang=\"\$ooo_lang\"'"
var_append confopt ' ' "'--with-dict=\"\$ooo_lang\"'"

# Widgets and Icons
#
ooo_iconset=

# GNOME support
if pkginstalled gtk+; then
	# [ "$SDECFG_PKG_OOO_WIDGETS" = "gnome" ]
	var_append confopt ' ' "--enable-gtk"
	if pkginstalled libbonobo; then
		#[ "$SDECFG_PKG_OOO_BONOBO" = "1" ]
		var_append confopt ' ' "--with-bonobo"
	fi
	[ "$SDECFG_PKG_OOO_ICONS_GNOME" = "1" ] &&
		var_append ooo_iconset ',' "gnome"
else
	var_append confopt ' ' "--disable-gtk"
fi

# KDE support
if pkginstalled arts; then
	# [ "$SDECFG_PKG_OOO_WIDGETS" = "kde" ]
	var_append confopt ' ' "--enable-kde"
	[ "$SDECFG_PKG_OOO_ICONS_KDE" = "1" ] &&
		var_append ooo_iconset ',' "kde"

	export QTLIB=$QTDIR/lib
else
	var_append confopt ' ' "--disable-kde"
fi

if ! pkginstalled gnome-vfs; then
	var_append confopt ' ' '--disable-gnome-vfs'
fi

if pkginstalled openldap; then
	var_append GCC_WRAPPER_APPEND ' ' "-I`pkgprefix includedir openldap`"
	var_append GCC_WRAPPER_APPEND ' ' "-L`pkgprefix libdir openldap`"
else
	var_append confopt ' ' '--disable-ldap'
fi

# disable cairo support, for now
var_append confopt ' ' "--enable-cairo=no"
# disable mdb/access support, for now
var_append confopt ' ' "--enable-access=no"
# disable mono support, for now
var_append confopt ' ' "--enable-mono=no"

#FIXME: download location [ "$SDECFG_PKG_OOO_ICONS_BLUECURVE" = "1" ] && var_append ooo_iconset ',' "Bluecurve"
[ -n "$ooo_iconset" ] && var_append confopt ' ' "--with-icons=$ooo_iconset"

#Additional documentation
# TODO: CONFIG
var_append confopt ' ' "--with-docdir=$docdir"

# GCC
# NOTE: we patch gcc33 support to use what jsaw wanted :)
var_append confopt ' ' "--enable-gcc33"

# Architecture
cpu="`echo $arch | arch2uname`"
var_append confopt ' ' "--with-arch=$cpu"

hook_add preconf 5 'ooo_preconfigure'
ooo_preconfigure() {
	# i don't want this common config, at least for now -mnemoc
	cat /dev/null > distro-configs/Common.conf.in

	# fixed config
	cat <<-EOT > distro-configs/T2.conf
	--without-gpc
	--enable-crashdump=no
	--disable-crashdump
	--disable-binfilter
	--disable-epm

	--with-system-gcc
	--with-system-zlib
	--with-system-freetype
	--with-system-expat
	--with-system-neon
	--with-system-curl
	--with-system-jpeg
	--with-system-libxml
	--with-system-python

	--with-system-db
	--with-db-version=4.3

	--enable-fontconfig
	--without-myspell-dicts
	--without-fonts

	EOT

	# conditional config
	#
	{
	pkginstalled firefox &&
		echo -e "--with-system-mozilla\n--with-firefox" || 
		echo "--enable-build-mozilla"

	pkginstalled libart_lgpl23 &&
		echo "--enable-libart"

	pkginstalled startup-notification &&
		echo "--enable-libsn"

	if pkginstalled nas; then
	       	echo "--with-system-nas"
		export LDFLAGS=-L`pkgprefix libdir libx11`
		export CFLAGS=-I/usr/X11/include
		export CPPFLAGS=-I/usr/X11/include
	fi

	if [[ $libdir == *lib64 ]]; then
		echo "--enable-64bit-libs=yes"
	fi

	# Java support
	#
	#if [ "$JAVA_HOME" ] && pkginstalled apache-ant; then
	#	echo "--with-java=java"
	#	echo "--with-jdk-home=$root$JAVA_HOME"
	#	echo "--with-ant-home=$root/$( pkgprefix apache-ant )"
	#	echo "--with-db-jar=$root$( pkgprefix libdir java-dirtree )/libdb_java-4.3.jar"
	#else
		echo "--with-java=no"
	#fi
	} >> distro-configs/T2.conf

	cp distro-configs/T2{,64}.conf
}

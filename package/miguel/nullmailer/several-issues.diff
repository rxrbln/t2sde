# --- ROCK-COPYRIGHT-NOTE-BEGIN ---
# 
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# Please add additional copyright information _after_ the line containing
# the ROCK-COPYRIGHT-NOTE-END tag. Otherwise it might get removed by
# the ./scripts/Create-CopyPatch script. Do not edit this copyright text!
# 
# ROCK Linux: rock-src/package/miguel/nullmailer/several-issues.diff
# ROCK Linux is Copyright (C) 1998 - 2003 Clifford Wolf
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version. A copy of the GNU General Public
# License can be found at Documentation/COPYING.
# 
# Many people helped and are helping developing ROCK Linux. Please
# have a look at http://www.rocklinux.org/ and the Documentation/TEAM
# file for details.
# 
# --- ROCK-COPYRIGHT-NOTE-END ---

diff -Nru3 nullmailer-1.00RC5/lib/hostname.cc nullmailer/lib/hostname.cc
--- nullmailer-1.00RC5/lib/hostname.cc	2000-12-30 05:02:46.000000000 +0200
+++ nullmailer/lib/hostname.cc	2002-11-26 22:33:18.000000000 +0200
@@ -21,13 +21,14 @@
 
 #include "config.h"
 #include "mystring/mystring.h"
+#include <string.h>
 #include <unistd.h>
 #include <sys/utsname.h>
 
 static mystring* hostname_cache = 0;
 static mystring* domainname_cache = 0;
 
-#ifdef HAVE_GETDOMAINNAME
+#ifndef HAVE_GETDOMAINNAME
 // Re-declare the prototype here, as some systems don't declare it
 // in a predictable header file.
 extern "C" int getdomainname();
@@ -42,7 +43,7 @@
   hostname_cache = new mystring(buf.nodename);
 
 #ifdef UTSNAME_HAS_DOMAINNAME
-  domainname_cache = new mystring(buf.UTSNAME_HAS_DOMAINNAME);
+  domainname_cache = new mystring(buf.domainname);
 #else
 #ifdef HAVE_GETDOMAINNAME
   char hbuf[256];
diff -Nru3 nullmailer-1.00RC5/lib/makefield.cc nullmailer/lib/makefield.cc
--- nullmailer-1.00RC5/lib/makefield.cc	2000-06-15 18:12:21.000000000 +0300
+++ nullmailer/lib/makefield.cc	2002-11-26 22:33:18.000000000 +0200
@@ -21,6 +21,7 @@
 
 #include "config.h"
 #include "defines.h"
+#include <time.h>
 #include <sys/time.h>
 #include <unistd.h>
 #include "itoa.h"
diff -Nru3 nullmailer-1.00RC5/protocols/Makefile.in nullmailer/protocols/Makefile.in
--- nullmailer-1.00RC5/protocols/Makefile.in	2000-12-30 06:22:56.000000000 +0200
+++ nullmailer/protocols/Makefile.in	2002-11-26 22:33:18.000000000 +0200
@@ -87,7 +87,7 @@
 DEFS = @DEFS@ -I. -I$(srcdir) -I..
 CPPFLAGS = @CPPFLAGS@
 LDFLAGS = @LDFLAGS@
-LIBS = @LIBS@
+LIBS = @LIBS@ -lstdc++
 smtp_OBJECTS =  smtp.o protocol.o
 smtp_DEPENDENCIES =  ../lib/cli/libcli.a ../lib/libnullmailer.a
 smtp_LDFLAGS = 
diff -Nru3 nullmailer-1.00RC5/src/Makefile.in nullmailer/src/Makefile.in
--- nullmailer-1.00RC5/src/Makefile.in	2000-12-30 06:22:57.000000000 +0200
+++ nullmailer/src/Makefile.in	2002-11-26 22:33:18.000000000 +0200
@@ -101,7 +101,7 @@
 DEFS = @DEFS@ -I. -I$(srcdir) -I..
 CPPFLAGS = @CPPFLAGS@
 LDFLAGS = @LDFLAGS@
-LIBS = @LIBS@
+LIBS = @LIBS@ -lstdc++
 mailq_OBJECTS =  mailq.o
 mailq_DEPENDENCIES =  ../lib/libnullmailer.a
 mailq_LDFLAGS = 
diff -Nru3 nullmailer-1.00RC5/src/send.cc nullmailer/src/send.cc
--- nullmailer-1.00RC5/src/send.cc	2000-07-12 19:48:37.000000000 +0300
+++ nullmailer/src/send.cc	2002-12-01 11:37:41.000000000 +0200
@@ -24,6 +24,7 @@
 #include <dirent.h>
 #include <errno.h>
 #include <signal.h>
+#include <stdlib.h>
 #include <string.h>
 #include <sys/stat.h>
 #include <sys/time.h>
@@ -308,9 +309,17 @@
   signal(SIGHUP, SIG_IGN);
   load_config();
   load_files();
-  for(;;) {
-    send_all();
-    do_select();
+
+  switch(fork()) {
+    case 0:
+      for(;;) {
+	send_all();
+	do_select();
+      }
+    case -1:
+      fout << "Could not fork main send message loop." << endl;
+      return 1;
   }
+      
   return 0;
 }
diff -Nru3 nullmailer-1.00RC5/test/Makefile.in nullmailer/test/Makefile.in
--- nullmailer-1.00RC5/test/Makefile.in	2000-12-30 06:22:57.000000000 +0200
+++ nullmailer/test/Makefile.in	2002-11-26 22:33:18.000000000 +0200
@@ -85,7 +85,7 @@
 DEFS = @DEFS@ -I. -I$(srcdir) -I..
 CPPFLAGS = @CPPFLAGS@
 LDFLAGS = @LDFLAGS@
-LIBS = @LIBS@
+LIBS = @LIBS@ -lstdc++
 address_test_OBJECTS =  address-test.o
 address_test_DEPENDENCIES =  ../lib/libnullmailer.a
 address_test_LDFLAGS = 

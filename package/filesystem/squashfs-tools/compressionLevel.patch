# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# T2 SDE: package/.../squashfs-tools/compressionLevel.patch
# Copyright (C) 2009 The T2 SDE Project
# 
# More information can be found in the files COPYING and README.
# 
# This patch file is dual-licensed. It is available under the license the
# patched project is licensed under, as long as it is an OpenSource license
# as defined at http://www.opensource.org/ (e.g. BSD, X11) or under the terms
# of the GNU General Public License as published by the Free Software
# Foundation; either version 2 of the License, or (at your option) any later
# version.
# --- T2-COPYRIGHT-NOTE-END ---

Adds -compressionLevel option to mksquashfs.

Signed-off-by: Lucas C. Villa Real <lucasvr@gobolinux.org>
Signed-off-by: Rene Rebe <rene@exactcode.de>

--- squashfs3.4/squashfs-tools/mksquashfs.c.vanilla	2009-01-29 13:56:59.000000000 +0100
+++ squashfs3.4/squashfs-tools/mksquashfs.c	2009-01-29 13:57:03.000000000 +0100
@@ -97,7 +97,7 @@ int columns;
 
 /* filesystem flags for building */
 int duplicate_checking = 1, noF = 0, no_fragments = 0, always_use_fragments = 0;
-int noI = 0, noD = 0, check_data = 0;
+int noI = 0, noD = 0, check_data = 0, cLevel = 9;
 int swap, silent = TRUE;
 long long global_uid = -1, global_gid = -1;
 int exportable = TRUE;
@@ -609,7 +609,7 @@ unsigned int mangle2(z_stream **strm, ch
 		stream->zfree = Z_NULL;
 		stream->opaque = 0;
 
-		if((res = deflateInit(stream, 9)) != Z_OK) {
+		if((res = deflateInit(stream, cLevel)) != Z_OK) {
 			if(res == Z_MEM_ERROR)
 				BAD_ERROR("zlib::compress failed, not enough memory\n");
 			else if(res == Z_STREAM_ERROR)
@@ -3398,6 +3398,16 @@ int main(int argc, char *argv[])
 					exit(1);
 				}
 			}
+		} else if(strcmp(argv[i], "-compressionLevel") == 0) {
+			if(++i == argc) {
+				ERROR("%s: -compressionLevel requires a parameter\n", argv[0]);
+				exit(1);
+			}
+			cLevel = atoi(argv[i]);
+			if (cLevel < 0 || cLevel > 9) {
+				ERROR("%s: -compressionLevel out of range\n", argv[0]);
+				exit(1);
+			}
 		} else if(strcmp(argv[i], "-noI") == 0 ||
 				strcmp(argv[i], "-noInodeCompression") == 0)
 			noI = TRUE;
@@ -3480,6 +3491,8 @@ printOptions:
 			ERROR("-nopad\t\t\tdo not pad filesystem to a multiple of 4K\n");
 			ERROR("-check_data\t\tadd checkdata for greater filesystem checks\n");
 			ERROR("-root-owned\t\talternative name for -all-root\n");
+			ERROR("-compressionLevel\tzlib compression level (0 - 9),\n");
+			ERROR("\t\t\t0(no compression), 1(best speed) and 9(best compression)\n");
 			ERROR("-noInodeCompression\talternative name for -noI\n");
 			ERROR("-noDataCompression\talternative name for -noD\n");
 			ERROR("-noFragmentCompression\talternative name for -noF\n");

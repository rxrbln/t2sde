# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# T2 SDE: package/.../lua-pcre/lrexlib-conf.in
# Copyright (C) 2006 The T2 SDE Project
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- T2-COPYRIGHT-NOTE-END ---


build_lrexlib_module() {
	eval $MAKE so_$1

	pkglibdir=$root/`lua-config --pkglibdir` ; mkdir -p $pkglibdir
	pkgdatadir=$root/`lua-config --pkgdatadir`/$1 ; mkdir -p $pkgdatadir

	cp -av $1.so $pkglibdir/l$1.so

	cat << EOF > $pkgdatadir/init.lua
-- Note: this is a modified version of lrexlib-$ver
require "l$1"

setmetatable($1, {__call =
  function (self, p, cf, lo)
    return self.new(p, cf, lo)
  end})

-- partial string.find equivalent
function $1.find(s, p, st)
  return $1(p):match(s, st)
end

-- partial string.gsub equivalent
function $1.gsub(s, p, f, n)
  return $1(p):gmatch(s, f, n)
end

EOF
}

build_lrexlib_string_replacements() {
	pkgdatadir=$root/`lua-config --pkgdatadir`/$1
	cat << EOF > $pkgdatadir/string.lua
-- Copyright (C) 2006 Juergen "George" Sawinski
--                    The T2 SDE Project
-- 
-- This program is free software; you can redistribute it and/or modify
-- it under the terms of the GNU General Public License as published by
-- the Free Software Foundation; version 2 of the License. A copy of the
-- GNU General Public License can be found in the file COPYING.

require "$1"

function string.gsub(str, pat, repl, n)
  return generic_gsub($1.new, str, pat, repl, n)
end


-- FIXME implement:
-- function string.match(s, pat, init)
-- function string.gmatch(s, pat)
-- function string.find(s, pat, init) -- forth argument is ignored!

-- original lrexlib/gsub.lua:
EOF
	cat gsub.lua >> $pkgdatadir/string.lua
}

build_lrexlib() {
	build_lrexlib_module $1
	build_lrexlib_string_replacements $1
}


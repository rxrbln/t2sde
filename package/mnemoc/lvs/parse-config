# --- ROCK-COPYRIGHT-NOTE-BEGIN ---
# 
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# Please add additional copyright information _after_ the line containing
# the ROCK-COPYRIGHT-NOTE-END tag. Otherwise it might get removed by
# the ./scripts/Create-CopyPatch script. Do not edit this copyright text!
# 
# ROCK Linux: rock-src/package/mnemoc/lvs/parse-config
# ROCK Linux is Copyright (C) 1998 - 2003 Clifford Wolf
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version. A copy of the GNU General Public
# License can be found at Documentation/COPYING.
# 
# Many people helped and are helping developing ROCK Linux. Please
# have a look at http://www.rocklinux.org/ and the Documentation/TEAM
# file for details.
# 
# --- ROCK-COPYRIGHT-NOTE-END ---

if pkgcheck lvs X; then
	if [ ${pkg:0:7} == linux24 ]; then
		echo_status "Including IP Virtual Server (lvs) patch..."
		pkg_lvs_confdir=$base/package/mnemoc/lvs
		pkg_lvs_archdir=$base/download/mnemoc/lvs
		pkg_lvs_ver=`sed -n 's,^\[V\] \(.*\),\1,p' ${pkg_lvs_confdir}/lvs.desc`
		pkg_lvs_srctar="ipvs-$pkg_lvs_ver.tar.bz2"

		if [ ! -r $pkg_lvs_archdir/$pkg_lvs_srctar ]; then
			abort "File \$base${pkg_lvs_archdir##$base}/$pkg_lvs_srctar not found"
		fi
	
		pkg_lvs_tempdir=`mktemp -d`
		pushd $pkg_lvs_tempdir > /dev/null
		tar $taropt $pkg_lvs_archdir/$pkg_lvs_srctar
		cd * ; for x in *.diff; do
			mv "$x" "lvs-$pkg_lvs_ver-${x%.diff}.patch"
		done 
		rm -rf ipvs/ipvsadm
		mv ipvs/linux_net_ipv4_ipvs_Makefile ipvs/Makefile
		popd > /dev/null

		pkg_lvs_patchdir=$pkg_lvs_tempdir/ipvs-$pkg_lvs_ver
		if [ ! -d $pkg_lvs_patchdir ]; then
			abort "Directory $pkg_lvs_patchdir not found... what happened?"
		fi

		# pre/postpatch actions.... add ipvs source
		hook_add prepatch  4 "cp -vrp $pkg_lvs_patchdir/ipvs net/ipv4"
		hook_add postpatch 4 "rm -rf $pkg_lvs_tempdir"
		
		# configure kernel
		var_append conffiles ' ' "$pkg_lvs_confdir/kernel-mod.conf.sh"

		# patch kernel
		patchfiles="$patchfiles `echo $pkg_lvs_patchdir/*.patch`"
	fi
fi

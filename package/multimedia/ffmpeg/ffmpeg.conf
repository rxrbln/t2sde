# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by scripts/Create-CopyPatch.
# 
# T2 SDE: package/*/ffmpeg/ffmpeg.conf
# Copyright (C) 2004 - 2021 The T2 SDE Project
# Copyright (C) 1998 - 2003 ROCK Linux Project
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- T2-COPYRIGHT-NOTE-END ---

hook_add preconf 5 'export TMPDIR="$(mktemp -d -p $PWD)"'

# use our (cross) toolchain for configure, too :-/
var_append extraconfopt " " "--cc=$CC --cxx=$CXX --ranlib=$RANLIB --host-cc=$CC"
var_append extraconfopt " " "--disable-stripping"

atstage cross && var_append extraconfopt " " "--enable-cross-compile --disable-doc"

# select architecture, for cross compilation
var_append extraconfopt " " "--arch=`echo $arch | arch2uname`"

# .so file location
var_append extraconfopt " " "--shlibdir=$libdir"

# fill options the configure does not attempt to detect ...
var_append confopt " " "--enable-pthreads"

pkginstalled lame && var_append extraconfopt " " "--enable-libmp3lame"
pkginstalled a52dec && var_append extraconfopt " " "--enable-liba52"
pkginstalled xvid && var_append extraconfopt " " "--enable-libxvid"
pkginstalled libtheora && var_append extraconfopt " " "--enable-libtheora"
pkginstalled x264 && var_append extraconfopt " " "--enable-libx264"
pkginstalled faac && var_append extraconfopt " " "--enable-libfaac --enable-nonfree"
pkginstalled faad && var_append extraconfopt " " "--enabled-libfaad"
pkginstalled libsdl2 || var_append extraconfopt " " "--disable-sdl2"
pkginstalled valgrind || var_append extraconfopt " " "--disable-valgrind-backtrace"

pkginstalled libext &&
	var_append extraconfopt " " "--enable-x11grab" &&
	var_append extraconfopt " " "--extra-ldflags=-L$root`pkgprefix libdir libxext`"
pkginstalled zlib && var_append extraconfopt " " "--enable-zlib"
pkginstalled libsdl || var_append extraconfopt " " "--disable-ffplay"
pkginstalled opencore-amr &&
	var_append extraconfopt " " "--enable-libopencore-amrnb --enable-libopencore-amrwb --enable-version3"
pkginstalled libdc1394 && pkginstalled libraw1394 && var_append extraconfopt " " "--enable-libdc1394"
pkginstalled freetype && var_append extraconfopt " " "--enable-libfreetype"
pkginstalled schroedinger && var_append extraconfopt " " "--enable-libschroedinger"
pkginstalled libvpx && var_append extraconfopt " " "--enable-libvpx"
pkginstalled speex && var_append extraconfopt " " "--enable-libspeex"
pkginstalled libcdio && var_append extraconfopt " " "--enable-libcdio"
pkginstalled gnutls && var_append extraconfopt " " "--enable-gnutls"
pkginstalled pulseaudio && var_append extraconfopt " " "--enable-libpulse"

# Imlib2 support
if pkginstalled imlib2; then
	pkgprefix -t imlib2
	var_append extraconfopt " " "--extra-cflags=-I$root/$( pkgprefix includedir imlib2 )"
	var_append extraconfopt " " "--extra-ldflags=-L$root/$( pkgprefix libdir imlib2 )"
fi

# Ogg Vorbis support
if pkginstalled libogg; then
	var_append extraconfopt " " "--enable-libogg"
	pkginstalled libvorbis && var_append extraconfopt " " "--enable-libvorbis"
fi

# MMX optimizations currently don't compile (version 0.4.8)
var_append confopt " " "--enable-gpl --enable-shared --enable-postproc"
var_append confopt " " "--enable-swscale"

# no fPIC for x86 right now
if [ "$arch" = "x86" ]; then
	var_remove GCC_WRAPPER_APPEND ' ' '-fPIC'

	# configure fails on lame (linker does not use libm with --as-needed)
	var_append GCC_WRAPPER_REMOVE ' ' '-Wl,--as-needed'
fi

var_append makeopt ' ' 'LD=$CC'
var_remove_regex makeopt ' ' 'STRIP=.*'
var_remove_regex makeopt ' ' 'AS=.*'

# --- T2-COPYRIGHT-BEGIN ---
# t2/package/*/flutter/flutter.conf
# Copyright (C) 2026 The T2 SDE Project
# SPDX-License-Identifier: GPL-2.0
# --- T2-COPYRIGHT-END ---

# All flutter sources live here permanently - survives reboots and T2 temp
# dir cleanups. The engine ninja output goes to flutter-engine-out/ next to it.
flutter_workdir=/usr/src/t2-src/flutter-build

depot_tools_extract() {
	# Skip if already extracted to the persistent workdir.
	[ -x $flutter_workdir/depot_tools/gclient ] && return 0
	mkdir -p $flutter_workdir
	tar -C $flutter_workdir/ $taropt $(match_source_file -p depot)
}

flutter_gclient_sync() {
	export PYTHONPATH=""
	export DEPOT_TOOLS_UPDATE=0
	export PATH="$flutter_workdir/depot_tools:$flutter_workdir/depot_tools/.cipd_bin:$PATH"

	# Skip clone if the flutter SDK is already present in the persistent workdir.
	if [ ! -d $flutter_workdir/flutter/.git ]; then
		git clone --depth=1 --branch $ver \
			https://github.com/flutter/flutter.git $flutter_workdir/flutter
	fi

	# Write (or overwrite) the gclient config.
	# Use custom_vars to disable downloads we don't need for a Linux desktop build:
	#   - Android SDK/tools/JDK/Gradle (not building for Android)
	#   - Fuchsia SDK (not building for Fuchsia)
	#   - esbuild (web engine only)
	#   - download_linux_deps (linux sysroot for cross-compilation; use host system)
	# Skip Fuchsia clang/reclient toolchains - building with system clang.
	cat > $flutter_workdir/flutter/.gclient << 'EOF'
solutions = [
  {
    "custom_vars": {
      "download_android_deps": False,
      "download_fuchsia_deps": False,
      "download_jdk": False,
      "download_esbuild": False,
      "download_linux_deps": False,
    },
    "custom_deps": {
      # Skip platform toolchains we don't need for a Linux desktop build.
      "engine/src/flutter/buildtools/mac-x64/clang":      None,
      "engine/src/flutter/buildtools/mac-arm64/clang":    None,
      "engine/src/flutter/buildtools/windows-x64/clang":  None,
      "engine/src/flutter/buildtools/linux-x64/reclient": None,
      "engine/src/flutter/buildtools/mac-arm64/reclient":  None,
      "engine/src/flutter/buildtools/mac-x64/reclient":   None,
      "engine/src/flutter/buildtools/windows-x64/reclient": None,
      # ANGLE sub-deps that gclient won't recurse into automatically.
      # Fetched explicitly here since recursedeps in .gclient is not
      # processed by this version of depot_tools.
      "engine/src/flutter/third_party/angle/third_party/astc-encoder/src":
        "https://chromium.googlesource.com/external/github.com/ARM-software/astc-encoder@573c475389bf51d16a5c3fc8348092e094e50e8f",
    },
    "deps_file": "DEPS",
    "managed": False,
    "name": ".",
    "safesync_url": "",
    "url": "https://github.com/flutter/flutter.git",
  },
]
EOF

	# vpython3 writes its venv cache under $HOME/.cache/.vpython-root.
	# When building as root the real $HOME may be a non-root user's dir
	# where root cannot change timestamps. Point HOME at the workdir so
	# vpython can always write its cache.
	export HOME="$flutter_workdir"

	cd $flutter_workdir/flutter
	nice -n 15 gclient sync --no-history --force
}

flutter_build_engine() {
	export PYTHONPATH=""
	export DEPOT_TOOLS_UPDATE=0
	export PATH="$flutter_workdir/depot_tools:$flutter_workdir/depot_tools/.cipd_bin:$PATH"

	local cpu
	case $arch in
	x86-64) cpu=x64   ;;
	arm64)  cpu=arm64  ;;
	*)      echo "Unsupported arch: $arch"; return 1 ;;
	esac

	cd $flutter_workdir/flutter/engine/src

	# The prebuilt gn binary deadlocks on glibc 2.34+ due to old-style
	# separate libpthread linkage. Replace it with a natively built copy
	# if available, otherwise fall back to the system gn package.
	local gn_native=$flutter_workdir/gn-src/out/gn
	local gn_system=$(command -v gn 2>/dev/null)
	if [ -x $gn_native ]; then
		cp $gn_native flutter/third_party/gn/gn
	elif [ -x "$gn_system" ]; then
		cp "$gn_system" flutter/third_party/gn/gn
	fi

	# Flutter's build_overrides/wayland.gni omits wayland_dir which ANGLE's
	# BUILD.gn needs unconditionally when angle_use_wayland=true. Point it
	# at the system wayland headers (use_default_linux_sysroot=false build).
	grep -q "^wayland_dir" build_overrides/wayland.gni 2>/dev/null || \
		echo 'wayland_dir = "/usr/include"' >> build_overrides/wayland.gni

	# ANGLE's BUILD.gn expects its own third_party/vulkan-deps but Flutter
	# puts the shared copy at flutter/third_party/vulkan-deps. Symlink it.
	[ -e flutter/third_party/angle/third_party/vulkan-deps ] || \
		ln -sfn $flutter_workdir/flutter/engine/src/flutter/third_party/vulkan-deps \
		        flutter/third_party/angle/third_party/vulkan-deps

	# ANGLE's DisplayVkXcb.cpp includes X11/Xutil.h after volk.h undefines
	# Bool/Status; patch it to restore those macros before the include.
	local xcb_src=flutter/third_party/angle/src/libANGLE/renderer/vulkan/linux/xcb/DisplayVkXcb.cpp
	grep -q "ifndef Bool" $xcb_src 2>/dev/null || \
		sed -i 's|#include <X11/Xutil.h>|// volk.h undefines Bool/Status; restore them for Xutil.h.\n#ifndef Bool\n#define Bool int\n#endif\n#ifndef Status\n#define Status int\n#endif\n#include <X11/Xutil.h>|' $xcb_src

	# X11/xcb headers live under /usr/X11R7 but clang only searches /usr/include.
	# Create symlinks so system includes and the linker can find them.
	[ -e /usr/include/xcb ] || ln -sfn /usr/X11R7/include/xcb /usr/include/xcb
	[ -e /usr/include/X11 ] || ln -sfn /usr/X11R7/include/X11 /usr/include/X11
	for lib in /usr/X11R7/lib64/libX*.so; do
		name=$(basename $lib)
		[ -e /usr/lib64/$name ] || ln -sfn $lib /usr/lib64/$name
	done

	# Redirect ninja output to the persistent filesystem.
	mkdir -p out
	local engine_out=/usr/src/t2-src/flutter-engine-out/linux_release_$cpu
	mkdir -p $engine_out
	ln -sfn $engine_out out/linux_release_$cpu

	./flutter/tools/gn \
		--linux \
		--linux-cpu $cpu \
		--runtime-mode release \
		--gn-args "use_default_linux_sysroot=false angle_build_tests=false"

	# Leave 2 cores free and run at low priority so the system stays
	# responsive throughout the multi-hour build.
	local jobs=$(( $(nproc) > 2 ? $(nproc) - 2 : 1 ))
	nice -n 15 ninja -j $jobs -C out/linux_release_$cpu
}

flutter_install() {
	local cpu
	case $arch in
	x86-64) cpu=x64   ;;
	arm64)  cpu=arm64  ;;
	esac

	local engine_out=/usr/src/t2-src/flutter-engine-out/linux_release_$cpu
	local engine_cache=$flutter_workdir/flutter/bin/cache/artifacts/engine/linux-x64
	[ "$cpu" = arm64 ] && engine_cache=$flutter_workdir/flutter/bin/cache/artifacts/engine/linux-arm64

	install -d $engine_cache
	for f in libflutter_linux_gtk.so icudtl.dat \
	          flutter_export.h flutter_messenger.h \
	          flutter_plugin_registrar.h flutter_texture_registrar.h \
	          flutter_linux_gtk.h flutter_macros.h flutter_embedder.h; do
		[ -f $engine_out/$f ] && cp $engine_out/$f $engine_cache/
	done
	# Flutter 3.x moved GTK headers into flutter_linux/ subdirectory
	[ -d $engine_out/flutter_linux ] && \
		cp -a $engine_out/flutter_linux $engine_cache/

	# Copy the Dart SDK from the engine build output into Flutter's cache so
	# 'flutter' doesn't attempt to download it at runtime.
	local dart_sdk_cache=$flutter_workdir/flutter/bin/cache/dart-sdk
	if [ -x $engine_out/dart-sdk/bin/dart ] && [ ! -x $dart_sdk_cache/bin/dart ]; then
		install -d $dart_sdk_cache
		rsync -a $engine_out/dart-sdk/ $dart_sdk_cache/
	fi
	# Write the stamp Flutter uses to confirm the Dart SDK matches the engine.
	local engine_ver=$(cat $flutter_workdir/flutter/bin/cache/engine.stamp 2>/dev/null)
	[ -n "$engine_ver" ] && echo "$engine_ver" > $flutter_workdir/flutter/bin/cache/engine-dart-sdk.stamp

	install -d $root/$prefix
	cp -a $flutter_workdir/flutter/. $root/$prefix/

	install -d $root/usr/bin
	ln -sf /$prefix/bin/flutter $root/usr/bin/flutter
}

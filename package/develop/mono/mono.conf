# --- T2-COPYRIGHT-NOTE-BEGIN ---
# T2 SDE: package/*/mono/mono.conf
# Copyright (C) 2004 - 2021 The T2 SDE Project
# Copyright (C) 1998 - 2003 ROCK Linux Project
# 
# This Copyright note is generated by scripts/Create-CopyPatch,
# more information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2.
# --- T2-COPYRIGHT-NOTE-END ---

. $base/package/*/mono/mono.in

var_append extraconfopt ' ' '--enable-parallel-mark'
var_append extraconfopt ' ' '--disable-rpath'
var_append extraconfopt ' ' '--disable-nunit-test'
var_append extraconfopt ' ' '--disable-dtrace'
var_append extraconfopt ' ' '--disable-nacl-codegen'
var_append extraconfopt ' ' '--disable-nacl-gc'
var_append extraconfopt ' ' '--disable-nls'
var_append extraconfopt ' ' '--with-sigaltstack=no'
var_append extraconfopt ' ' '--with-shared_mono=yes'
var_append extraconfopt ' ' '--with-sgen=yes'
var_append extraconfopt ' ' '--with-static_mono=yes'
var_append extraconfopt ' ' '--with-xen-opt=no'
var_append extraconfopt ' ' '--with-large-heap=yes'
var_append extraconfopt ' ' '--with-mcs-docs=no'
var_append extraconfopt ' ' '--with-ikvm-native=no'
var_append extraconfopt ' ' '--with-moonlight=no'
var_append extraconfopt ' ' '--enable-small-config=no'
var_append extraconfopt ' ' '--with-gc=included'
var_append extraconfopt ' ' '--with-tls=__thread'
var_append extraconfopt ' ' '--with-small-config=no'
var_append extraconfopt ' ' '--with-ikvm-native=no'
var_append extraconfopt ' ' '--with-profile4=yes'

mono_dir_version=4.6.2

build_support() {
       if [ -d "$builddir/$pkg-$mono_dir_version/support" ]; then
	   cd $builddir/$pkg-$mono_dir_version/support
	   $MAKE
	   cd $builddir/$pkg-$mono_dir_version
       fi
}

install_support() {
       mkdir -p ${libdir}
       install -m 777 $builddir/$pkg-$mono_dir_version/support/.libs/libMonoPosixHelper.so $root$libdir/libMonoPosixHelper.so
       install -m 777 $builddir/$pkg-$mono_dir_version/support/.libs/libMonoSupportW.so $root$libdir/libMonoSupportW.so
}

fix_pkgconfig() {
	local f

	find -name '*.pc.in' | while read f; do
	        sed -i "s,^libdir=.*/lib,\0${libdir##*/lib}," $f
	done
	
}

[[ $libdir != */lib ]] && hook_add preconf 3 fix_pkgconfig
hook_add postmake 3 "build_support"
hook_add postinstall 5 "install_support"

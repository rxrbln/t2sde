# --- ROCK-COPYRIGHT-NOTE-BEGIN ---
# 
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# Please add additional copyright information _after_ the line containing
# the ROCK-COPYRIGHT-NOTE-END tag. Otherwise it might get removed by
# the ./scripts/Create-CopyPatch script. Do not edit this copyright text!
# 
# ROCK Linux: rock-src/package/base/sysfiles/sysfiles.conf
# ROCK Linux is Copyright (C) 1998 - 2003 Clifford Wolf
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version. A copy of the GNU General Public
# License can be found at Documentation/COPYING.
# 
# Many people helped and are helping developing ROCK Linux. Please
# have a look at http://www.rocklinux.org/ and the Documentation/TEAM
# file for details.
# 
# --- ROCK-COPYRIGHT-NOTE-END ---

main_sf() {
	cd $root/

	echo "Creating various etc/* files ..."
	mkdir -p etc/conf etc/rc.d etc/stone.d
	for x in $( cd $confdir ; echo etc_*.txt ) ; do
		y="${x%.txt}" ; z="/"
		#if [ -f "${y//_/$z}" ]
		#then
		#	echo "Found old ${y//_/$z} (don't overwrite)."
		#else
			cp -v "$confdir/$x" "${y//_/$z}"
		#fi
	done
	[ -f etc/HOSTNAME ] || echo localhost > etc/HOSTNAME
	chmod +x etc/initscript etc/rc.d/rc

	echo "Add missing entries to etc/services .."
	{	echo -e '\n# Entries from http://www.graffiti.com/services\n#'
		while read line ; do
			prot=`echo $line | cut -f2 -d' '`
			grep -q " $prot " $root/etc/services || echo "$line"
		done < $archdir/services.txt
	} >> $root/etc/services

	echo "Creating usr/sbin/sysnote ..."
	cat > usr/sbin/sysnote << EOT
#!/bin/sh
${EDITOR:-vi} /etc/conf/NOTE
chmod 600 /etc/conf/NOTE
chown 0.0 /etc/conf/NOTE
EOT
	chmod +x usr/sbin/sysnote

	echo "Installing the stone setup tool ..."
	cp -v $confdir/stone.sh usr/sbin/stone
	chmod +x usr/sbin/stone ; mkdir -p etc/stone.d
	for x in $( cd $confdir ; echo stone_*.sh ) ; do
		cp -v $confdir/$x etc/stone.d/${x#stone_}
	done

	echo "Create /etc/issue, /etc/issue.ansi and /etc/issue.net ... "
	rocktxt="ROCK Linux $rockver $arch"
	. $confdir/issue-std.sh
	. $confdir/$ROCKCFG_SYSFILE_ANSI_ISSUE
	. $confdir/issue-net.sh

	echo "Set ownership and permissions ... "
	chmod 640   etc/shadow
	chown 0:3   etc/shadow
	chmod 750   etc/rc.d
	touch       var/log/wtmp var/run/utmp
	chmod 664   var/log/wtmp var/run/utmp
	chown 0:5   var/log/wtmp var/run/utmp

	echo "Creating etc/mtab ..."
	# ln -fvs ../proc/mounts etc/mtab
	touch etc/mtab

	echo "Creating etc/skel/.profile and etc/skel/.exrc ..."
	cp $confdir/skel-profile.txt etc/skel/.profile
	echo 'set showmode' > etc/skel/.exrc

	echo "Creating etc/VERSION, etc/ROCK-VERSION and etc/ROCK-CONFIG ..."
	echo "ROCK Linux $rockver (`date +%Y/%m/%d`)" > etc/ROCK-VERSION
	ln -sf ROCK-VERSION etc/VERSION ; rm -rf etc/ROCK-CONFIG
	cp -r $base/config/$config/. etc/ROCK-CONFIG

	echo "Building btee ..."
	cmd="$CC -Wall -O2 $confdir/btee.c -o $root/sbin/btee"
	echo "$cmd" ; $cmd

	echo "Building rc ..."
	cmd="$CC -Wall -O2 $confdir/rc.c -o $root/sbin/rc"
	echo "$cmd" ; $cmd

	cp -v $confdir/hwscan.awk $root/sbin/hwscan
	chmod +x $root/sbin/hwscan

	install_init system $confdir/system.init
	install_init hardware $confdir/hardware.init

	if [ $stagelevel -gt 1 ] ; then
		for x in $base/misc/*/postsysfiles.in
		do [ -f $x ] && . $x ; done
		for x in $base/package/*/*/postsysfiles.in
		do
			y=${x%/*}; y=${y##*/}
			if [ -f $x ] && pkgcheck "$y" "X"
			then . $x; fi
		done
	fi ; true
}

custmain="main_sf"
autoextract=0
check_usrlocal=0


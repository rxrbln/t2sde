#!/bin/sh
# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# T2 SDE: package/.../uclibc/uclibc.conf
# Copyright (C) 2004 - 2005 The T2 SDE Project
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- T2-COPYRIGHT-NOTE-END ---
. $confdir/functions.in

uclibc_preparelocale() {
	find ./charmaps -name "*.pairs" > codesets.txt
	cp LOCALES locales.txt
}
uclibc_kernellinks() {
	ln -svf $root/usr/include/linux include/linux
	ln -svf $root/usr/include/asm   include/asm
}

if [ $ROCKCFG_CROSSBUILD = 1 ]; then
	var_append makeopt " " "CROSS=${arch_target}-"
	var_append makeinstopt " " "CROSS=${arch_target}-"
fi

# rulesets
var_append conffiles ' ' $confdir/clean_arch.config
var_append conffiles ' ' $builddir/.config

default_config()
{
	# TARGET_ARCH (a bit messy due to uclibc's sh5 / sh64 handling ...)
	cpu=`echo "$arch_machine" | sed -e s/i.86/i386/ -e s/sh.$/sh/`
	arch=`echo $cpu | sed -e s/sh64/sh/`
	echo "X TARGET_$arch"
	echo "X TARGET_ARCH \"$cpu\""
	[ $cpu = sh64 ] && echo -e "O CONFIG_SH4\nX CONFIG_SH5"

	if [ "$arch_bigendian" = "yes" ]; then
		echo "X ARCH_BIG_ENDIAN"
	else
		echo "X ARCH_LITTLE_ENDIAN"
	fi

	# PREFIX
	if [ $stagelevel -eq 0 ]; then
		echo "X KERNEL_SOURCE \"$base/build/$ROCKCFG_ID/usr\""
	else
		echo "X KERNEL_SOURCE \"$root/usr\""
	fi
	echo "X RUNTIME_PREFIX \"/\""
	#echo "X DEVEL_PREFIX \"/usr/lib/uclibc\""	# NOTE: why there?
	echo "X DEVEL_PREFIX \"/usr\""
	echo "X SHARED_LIB_LOADER_PREFIX \"/lib\""

	# locale
	if [ "$ROCKCFG_DISABLE_NLS" = "0" ]; then
		echo "X UCLIBC_HAS_LOCALE"
	fi
	# turning off locale will break ncurses
	
	# ld.so preload
	echo "X LDSO_PRELOAD_FILE_SUPPORT"

	# util-linux needs it to build some mounts
	# FIXME: this has to be done in the oposite way (disable those mounts 
	#        if libc doesn't have support)
	echo "X UCLIBC_HAS_RPC"
	echo "X UCLIBC_HAS_FULL_RPC"

	# to get rint (iproute2)
	echo "X DO_C99_MATH"

	# to make reiserfsprogs happy
	echo "X UCLIBC_HAS_GLIBC_CUSTOM_PRINTF"
	# to make sed happy
	echo "X UCLIBC_HAS_WCHAR"

	# I want V6
	echo "X UCLIBC_HAS_IPV6"

	#echo "X UCLIBC_HAS_LOCALE"

	# needed for attr
	echo "X UCLIBC_HAS_FTW"

	# needed for acl (among others)
	echo "X UCLIBC_HAS_GETTEXT_AWARENESS"

	echo "X UCLIBC_HAS_GNU_GETOPT"
	echo "X UCLIBC_HAS_GLOB"
	echo "X UCLIBC_HAS_FLOATS"
}

if [ "$ROCKCFG_DISABLE_NLS" = "0" ]; then
	hook_add preconf 5 '( cd extra/locale; uclibc_preparelocale )'
	var_append patchfiles ' ' $confdir/make_locale_after_headers.diff
fi

uclibc_preconf()
{
	# add custom/target configuration from $targetdir
	if [ -e $targetdir/uclibc.config ] ; then
		var_append conffiles ' ' $targetdir/uclibc.config
	fi
	default_config > $builddir/.config
}
hook_add preconf 3 "uclibc_preconf"

uclibc_stage0() {
	hook_eval preconf
	# FIXME: inject X options early - so 2 loops are enough
	auto_config 3
	eval $MAKE $makeopt headers
	
	# remove symlinks to avoid shares (install_dev)
	rm -vf include/{asm,asm-generic,linux}

	eval $MAKE $makeinstopt install_dev
}

uclibc_main() {
	hook_eval preconf
	# FIXME: inject X options early - so 2 loops are enough
	auto_config 3
	eval $MAKE $makeopt pregen
	eval $MAKE $makeopt all
		
	# remove symlinks to avoid shares (install_dev)
	rm -vf include/{asm,asm-generic,linux}

	eval $MAKE $makeinstopt install_dev
	eval $MAKE $makeinstopt install_runtime

	# utils (ldd, ldconfig )
	uclibc_kernellinks
	eval $MAKE $makeopt -C utils
	eval $MAKE $makeinstopt install_utils
}

#var_append makeopt ' ' "RUNTIME_PREFIX=/ DEVEL_PREFIX=/usr"	# this or base config must point to /usr
var_remove_regex makeopt ' ' 'prefix=[^ ]*'

if [ $stagelevel -eq 0 ]; then
	var_append makeopt ' ' PREFIX=$base/build/$ROCKCFG_ID
	custmain=uclibc_stage0
else
	var_append makeopt ' ' PREFIX=$root
	custmain=uclibc_main
fi

hook_add postdoc 5 'cp -v .config $root/$docdir/'
makeinstopt="$makeopt"
runconf=0

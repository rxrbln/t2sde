# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# T2 SDE: package/.../grub-sunos/gcc-4.0-linux.patch
# Copyright (C) 2008 The T2 SDE Project
# 
# More information can be found in the files COPYING and README.
# 
# This patch file is dual-licensed. It is available under the license the
# patched project is licensed under, as long as it is an OpenSource license
# as defined at http://www.opensource.org/ (e.g. BSD, X11) or under the terms
# of the GNU General Public License as published by the Free Software
# Foundation; either version 2 of the License, or (at your option) any later
# version.
# --- T2-COPYRIGHT-NOTE-END ---

diff -r b18ad135e7f4 -r adb38167ee13 config.h
--- a/config.h	Fri Aug 15 20:45:02 2008 +0200
+++ b/config.h	Fri Aug 15 21:14:53 2008 +0200
@@ -29,7 +29,7 @@
 #define HAVE_INTTYPES_H 1
 
 /* Define if you have a curses library */
-#define HAVE_LIBCURSES 1
+/* #undef HAVE_LIBCURSES */
 
 /* Define to 1 if you have the <memory.h> header file. */
 #define HAVE_MEMORY_H 1
@@ -38,7 +38,7 @@
 /* #undef HAVE_NCURSES_CURSES_H */
 
 /* Define to 1 if you have the <ncurses.h> header file. */
-/* #undef HAVE_NCURSES_H */
+#define HAVE_NCURSES_H 1
 
 /* Define if opendisk() in -lutil can be used */
 /* #undef HAVE_OPENDISK */
diff -r b18ad135e7f4 -r adb38167ee13 grub/Makefile.am
--- a/grub/Makefile.am	Fri Aug 15 20:45:02 2008 +0200
+++ b/grub/Makefile.am	Fri Aug 15 21:14:53 2008 +0200
@@ -13,7 +13,7 @@
 	$(SERIAL_FLAGS) -I$(top_srcdir)/stage2 \
 	-I$(top_srcdir)/stage1 -I$(top_srcdir)/lib
 
-AM_CFLAGS = $(GRUB_CFLAGS) -fwritable-strings
+AM_CFLAGS = $(GRUB_CFLAGS)
 
 grub_SOURCES = main.c asmstub.c
 grub_LDADD = ../stage2/libgrub.a  ../lib/libcommon.a $(GRUB_LIBS)
diff -r b18ad135e7f4 -r adb38167ee13 grub/Makefile.in
--- a/grub/Makefile.in	Fri Aug 15 20:45:02 2008 +0200
+++ b/grub/Makefile.in	Fri Aug 15 21:14:53 2008 +0200
@@ -185,7 +185,7 @@
 	$(SERIAL_FLAGS) -I$(top_srcdir)/stage2 \
 	-I$(top_srcdir)/stage1 -I$(top_srcdir)/lib
 
-AM_CFLAGS = $(GRUB_CFLAGS) -fwritable-strings
+AM_CFLAGS = $(GRUB_CFLAGS)
 grub_SOURCES = main.c asmstub.c
 grub_LDADD = ../stage2/libgrub.a  ../lib/libcommon.a $(GRUB_LIBS)
 all: all-am
diff -r b18ad135e7f4 -r adb38167ee13 grub/asmstub.c
--- a/grub/asmstub.c	Fri Aug 15 20:45:02 2008 +0200
+++ b/grub/asmstub.c	Fri Aug 15 21:14:53 2008 +0200
@@ -90,7 +90,7 @@
 static jmp_buf env_for_exit;
 
 /* The current color for console.  */
-static int console_current_color = A_NORMAL;
+int console_current_color = A_NORMAL;
 
 /* The file descriptor for a serial device.  */
 static int serial_fd = -1;
@@ -115,7 +115,7 @@
 
   /* We need a nested function so that we get a clean stack frame,
      regardless of how the code is optimized. */
-  static volatile void doit ()
+  void doit ()
   {
     /* Make sure our stack lives in the simulated memory area. */
     asm volatile ("movl %%esp, %0\n\tmovl %1, %%esp\n"
@@ -1282,23 +1282,23 @@
   return 1;
 }
 
-uint32_t amd64_cpuid_supported(void)
+unsigned int amd64_cpuid_supported(void)
 {
   /* Nothing to do in the simulator. */
 	return (1);
 }
 
-void amd64_cpuid_insn(uint32_t i, void * r)
+void amd64_cpuid_insn(unsigned int i, void * r)
 {
   /* Nothing to do in the simulator. */
 }
 
-void amd64_rdmsr(uint32_t i, uint64_t * p)
+void amd64_rdmsr(unsigned int i, unsigned long long* p)
 {
   /* Nothing to do in the simulator. */
 }
 
-void amd64_wrmsr(uint32_t i, const uint64_t * p)
+void amd64_wrmsr(unsigned int i, unsigned long long* p)
 {
   /* Nothing to do in the simulator. */
 }
diff -r b18ad135e7f4 -r adb38167ee13 lib/device.c
--- a/lib/device.c	Fri Aug 15 20:45:02 2008 +0200
+++ b/lib/device.c	Fri Aug 15 21:14:53 2008 +0200
@@ -519,12 +519,12 @@
 static int
 read_device_map (FILE *fp, char **map, const char *map_file)
 {
-  static void show_error (int no, const char *msg)
+  void show_error (int no, const char *msg)
     {
       fprintf (stderr, "%s:%d: error: %s\n", map_file, no, msg);
     }
   
-  static void show_warning (int no, const char *msg, ...)
+  void show_warning (int no, const char *msg, ...)
     {
       va_list ap;
       
diff -r b18ad135e7f4 -r adb38167ee13 stage2/Makefile.am
--- a/stage2/Makefile.am	Fri Aug 15 20:45:02 2008 +0200
+++ b/stage2/Makefile.am	Fri Aug 15 21:14:53 2008 +0200
@@ -26,8 +26,7 @@
 	-DGRUB_UTIL=1 -DFSYS_EXT2FS=1 -DFSYS_FAT=1 -DFSYS_FFS=1 \
 	-DFSYS_ISO9660=1 -DFSYS_JFS=1 -DFSYS_MINIX=1 -DFSYS_REISERFS=1 \
 	-DFSYS_UFS=1 -DFSYS_UFS2=1 -DFSYS_ZFS=1 -DFSYS_VSTAFS=1 -DFSYS_XFS=1 \
-	-DUSE_MD5_PASSWORDS=1 -DSUPPORT_SERIAL=1 -DSUPPORT_HERCULES=1 \
-	-fwritable-strings
+	-DUSE_MD5_PASSWORDS=1 -DSUPPORT_SERIAL=1 -DSUPPORT_HERCULES=1
 
 # Stage 2 and Stage 1.5's.
 pkglibdir = $(libdir)/$(PACKAGE)/$(host_cpu)-$(host_vendor)
diff -r b18ad135e7f4 -r adb38167ee13 stage2/Makefile.in
--- a/stage2/Makefile.in	Fri Aug 15 20:45:02 2008 +0200
+++ b/stage2/Makefile.in	Fri Aug 15 21:14:53 2008 +0200
@@ -660,8 +660,7 @@
 	-DGRUB_UTIL=1 -DFSYS_EXT2FS=1 -DFSYS_FAT=1 -DFSYS_FFS=1 \
 	-DFSYS_ISO9660=1 -DFSYS_JFS=1 -DFSYS_MINIX=1 -DFSYS_REISERFS=1 \
 	-DFSYS_ZFS=1 -DFSYS_UFS=1 -DFSYS_UFS2=1 -DFSYS_VSTAFS=1 -DFSYS_XFS=1 \
-	-DUSE_MD5_PASSWORDS=1 -DSUPPORT_SERIAL=1 -DSUPPORT_HERCULES=1 \
-	-fwritable-strings
+	-DUSE_MD5_PASSWORDS=1 -DSUPPORT_SERIAL=1 -DSUPPORT_HERCULES=1
 
 @DISKLESS_SUPPORT_FALSE@pkglib_DATA = stage2 stage2_eltorito e2fs_stage1_5 fat_stage1_5 \
 @DISKLESS_SUPPORT_FALSE@	ffs_stage1_5 iso9660_stage1_5 jfs_stage1_5 minix_stage1_5 \
diff -r b18ad135e7f4 -r adb38167ee13 stage2/builtins.c
--- a/stage2/builtins.c	Fri Aug 15 20:45:02 2008 +0200
+++ b/stage2/builtins.c	Fri Aug 15 21:14:53 2008 +0200
@@ -166,7 +166,7 @@
 
   /* Collect contiguous blocks into one entry as many as possible,
      and print the blocklist notation on the screen.  */
-  static void disk_read_blocklist_func (int sector, int offset, int length)
+  void disk_read_blocklist_func (int sector, int offset, int length)
     {
       if (num_sectors > 0)
 	{
@@ -627,7 +627,7 @@
   };
 
   /* Convert the color name STR into the magical number.  */
-  static int color_number (char *str)
+  int color_number (char *str)
     {
       char *ptr;
       int i;
@@ -2189,7 +2189,7 @@
 #endif /* GRUB_UTIL */
   
   /* Save the first sector of Stage2 in STAGE2_SECT.  */
-  static void disk_read_savesect_func (int sector, int offset, int length)
+  void disk_read_savesect_func (int sector, int offset, int length)
     {
       if (debug)
 	printf ("[%d]", sector);
@@ -2205,7 +2205,7 @@
 
   /* Write SECTOR to INSTALLLIST, and update INSTALLADDR and
      INSTALLSECT.  */
-  static void disk_read_blocklist_func (int sector, int offset, int length)
+  void disk_read_blocklist_func (int sector, int offset, int length)
     {
       if (debug)
 	printf("[%d]", sector);
@@ -4540,7 +4540,7 @@
   int to_code, from_code;
   int map_in_interrupt = 0;
   
-  static int find_key_code (char *key)
+  int find_key_code (char *key)
     {
       int i;
 
@@ -4557,7 +4557,7 @@
       return 0;
     }
   
-  static int find_ascii_code (char *key)
+  int find_ascii_code (char *key)
     {
       int i;
       
diff -r b18ad135e7f4 -r adb38167ee13 stage2/char_io.c
--- a/stage2/char_io.c	Fri Aug 15 20:45:02 2008 +0200
+++ b/stage2/char_io.c	Fri Aug 15 21:14:53 2008 +0200
@@ -1298,7 +1298,7 @@
 {
   int local_errnum = 0;
 #ifdef GRUB_UTIL
-  static unsigned long start_addr (void)
+   unsigned long start_addr (void)
     {
       int ret;
 # if defined(HAVE_START_SYMBOL)
@@ -1309,7 +1309,7 @@
       return ret;
     }
 
-  static unsigned long end_addr (void)
+  unsigned long end_addr (void)
     {
       int ret;
 # if defined(HAVE_END_SYMBOL)
diff -r b18ad135e7f4 -r adb38167ee13 stage2/disk_io.c
--- a/stage2/disk_io.c	Fri Aug 15 20:45:02 2008 +0200
+++ b/stage2/disk_io.c	Fri Aug 15 21:14:53 2008 +0200
@@ -127,7 +127,7 @@
 char current_bootpath[MAXNAMELEN];
 char current_rootpool[MAXNAMELEN];
 char current_bootfs[MAXNAMELEN];
-uint64_t current_bootfs_obj;
+unsigned long long current_bootfs_obj;
 char current_devid[MAXNAMELEN];
 int is_zfs_mount;
 unsigned long best_drive;
diff -r b18ad135e7f4 -r adb38167ee13 stage2/smp-imps.c
--- a/stage2/smp-imps.c	Fri Aug 15 20:45:02 2008 +0200
+++ b/stage2/smp-imps.c	Fri Aug 15 21:14:53 2008 +0200
@@ -249,15 +249,15 @@
  *  Exported globals here.
  */
 
-static int imps_any_new_apics = 0;
+int imps_any_new_apics = 0;
 #if 0
 volatile int imps_release_cpus = 0;
 #endif
-static int imps_enabled = 0;
-static int imps_num_cpus = 1;
-static unsigned imps_lapic_addr = ((unsigned) (&lapic_dummy)) - LAPIC_ID;
-static unsigned char imps_cpu_apic_map[IMPS_MAX_CPUS];
-static unsigned char imps_apic_cpu_map[IMPS_MAX_CPUS];
+int imps_enabled = 0;
+int imps_num_cpus = 1;
+unsigned imps_lapic_addr = ((unsigned) (&lapic_dummy)) - LAPIC_ID;
+unsigned char imps_cpu_apic_map[IMPS_MAX_CPUS];
+unsigned char imps_apic_cpu_map[IMPS_MAX_CPUS];
 
 
 /*
--- grub-sunos/netboot/nic.c.vanilla	2008-08-17 14:05:44.000000000 +0200
+++ grub-sunos/netboot/nic.c	2008-08-17 14:07:03.000000000 +0200
@@ -16,6 +16,7 @@
 **************************************************************************/
 #include "etherboot.h"
 #include "grub.h"
+#include "stage2/shared.h"
 #include "nic.h"
 #include "elf.h" /* FOR EM_CURRENT */
 #include "bootp.h"
--- grub-sunos/stage2/shared.h.vanilla	2008-08-17 14:15:06.000000000 +0200
+++ grub-sunos/stage2/shared.h	2008-08-17 14:15:22.000000000 +0200
@@ -715,10 +715,8 @@
 extern unsigned long saved_partition;
 extern unsigned long cdrom_drive;
 #ifndef STAGE1_5
-#ifdef SOLARIS_NETBOOT
 extern unsigned long dhcpack_length;
 extern unsigned long dhcpack_buf;
-#endif
 extern unsigned long saved_mem_upper;
 extern unsigned long extended_memory;
 #endif
--- grub-sunos/stage2/cpu.h.vanilla	2008-08-17 14:16:47.000000000 +0200
+++ grub-sunos/stage2/cpu.h	2008-08-17 14:17:44.000000000 +0200
@@ -26,6 +26,8 @@
 
 #pragma ident	"%Z%%M%	%I%	%E% SMI"
 
+#include "netboot/stdint.h"
+
 #ifdef	__cplusplus
 extern "C" {
 #endif
--- grub-sunos/stage2/common.c.vanilla	2008-08-17 14:36:26.000000000 +0200
+++ grub-sunos/stage2/common.c	2008-08-17 14:36:35.000000000 +0200
@@ -34,10 +34,8 @@
 unsigned long saved_partition;
 unsigned long cdrom_drive;
 #ifndef STAGE1_5
-#ifdef SOLARIS_NETBOOT
 unsigned long dhcpack_length;
 unsigned long dhcpack_buf;
-#endif /* SOLARIS_NETBOOT */
 unsigned long saved_mem_upper;
 
 /* This saves the maximum size of extended memory (in KB).  */

# --- T2-COPYRIGHT-BEGIN ---
# t2/package/*/localsend/localsend.conf
# Copyright (C) 2026 The T2 SDE Project
# SPDX-License-Identifier: GPL-2.0
# --- T2-COPYRIGHT-END ---

localsend_build() {
	# Flutter and Rust must be in PATH for the build.
	# cargo lives in /usr/bin on T2; /opt/rust/bin has rustc/rustdoc.
	# flutter_rust_bridge's cargokit also requires rustup in PATH; T2 installs
	# Rust directly without rustup, so create a compatibility shim.
	local fakebin=$builddir/fakebin
	install -d $fakebin
	cat > $fakebin/rustup << 'RUSTUP_EOF'
#!/bin/sh
# Fake rustup shim for cargokit on T2 SDE (Rust installed without rustup).
# T2 uses x86_64-t2-linux-gnu as its Rust target triple.
case "$1" in
toolchain)
	case "$2" in
	list)    echo "stable-x86_64-t2-linux-gnu (default)" ;;
	install) ;;
	esac ;;
target)
	case "$2" in
	list) echo "x86_64-t2-linux-gnu" ;;
	add)  ;;
	esac ;;
run) shift 2; exec "$@" ;;
*) echo "fake-rustup: unhandled: $*" >&2; exit 1 ;;
esac
RUSTUP_EOF
	chmod +x $fakebin/rustup
	export PATH="$fakebin:/opt/flutter/bin:/opt/rust/bin:/usr/bin:$PATH"
	export CARGO_HOME="$builddir/.cargo"

	local cpu
	case $arch in
	x86-64) cpu=x64   ;;
	arm64)  cpu=arm64  ;;
	*)      echo "Unsupported arch: $arch"; return 1 ;;
	esac

	cd $builddir/localsend-$ver/app

	# Flutter 3.38 SDK pins exact versions of some pub packages via
	# flutter_localizations. Relax localsend's constraints to match.
	sed -i \
		-e 's/^\( *path:\) 1\.9\.0/\1 ^1.9.0/' \
		-e 's/^\( *intl:\) \^0\.[0-9][0-9]*\.[0-9][0-9]*/\1 ^0.20.0/' \
		pubspec.yaml

	# Flutter 3.38 removed InputDecorationThemeData.borderRadius.
	# Replace the full expressions (both Theme.of(context).xxx and theme.xxx
	# local-variable forms) with a constant border radius.
	sed -i \
		-e 's/Theme\.of(context)\.inputDecorationTheme\.borderRadius/BorderRadius.circular(12.0)/g' \
		-e 's/theme\.inputDecorationTheme\.borderRadius/BorderRadius.circular(12.0)/g' \
		lib/pages/tabs/settings_tab.dart \
		lib/widget/custom_dropdown_button.dart \
		lib/widget/dialogs/text_field_tv.dart \
		lib/widget/dialogs/text_field_with_actions.dart

	# Fetch Dart package dependencies from pub.dev.
	flutter pub get

	# Flutter 3.38 renamed XxxTheme data classes to XxxThemeData; the old
	# names are now InheritedTheme widgets. Patch pinned deps that use the
	# old class names. These patches are idempotent.
	local pub=/root/.pub-cache/hosted/pub.dev
	sed -i \
		-e 's/^DialogTheme _createDialogTheme/DialogThemeData _createDialogTheme/' \
		-e 's/^  return DialogTheme(/  return DialogThemeData(/' \
		-e 's/^TabBarTheme _createTabBarTheme/TabBarThemeData _createTabBarTheme/' \
		-e 's/^  return TabBarTheme(/  return TabBarThemeData(/' \
		-e 's/^CardTheme _createCardTheme/CardThemeData _createCardTheme/' \
		-e 's/^  return CardTheme(/  return CardThemeData(/' \
		-e 's/bottomAppBarTheme: BottomAppBarTheme(/bottomAppBarTheme: BottomAppBarThemeData(/g' \
		$pub/yaru-5.3.2/lib/src/themes/common_themes.dart
	sed -i \
		's/bottomAppBarTheme: BottomAppBarTheme(/bottomAppBarTheme: BottomAppBarThemeData(/g' \
		$pub/wechat_assets_picker-9.5.0/lib/src/delegates/asset_picker_delegate.dart \
		$pub/wechat_picker_library-1.0.5/lib/src/themes.dart
	sed -i \
		's/final AppBarTheme appBarTheme = /final AppBarThemeData appBarTheme = /' \
		$pub/wechat_assets_picker-9.5.0/lib/src/widget/asset_picker_app_bar.dart

	# tray_manager uses app_indicator_new() which is deprecated in newer versions
	# of libayatana-appindicator3. Suppress the warning to avoid -Werror failure.
	sed -i \
		'/apply_standard_settings.*PLUGIN_NAME/a\\ttarget_compile_options(${PLUGIN_NAME} PRIVATE -Wno-deprecated-declarations)' \
		$pub/tray_manager-0.2.4/linux/CMakeLists.txt

	# cargokit (flutter_rust_bridge) hardcodes x86_64-unknown-linux-gnu as the
	# Linux Rust target, but T2's Rust stdlib is built for x86_64-t2-linux-gnu.
	# Patch all cargokit target.dart files in the pub cache to use the T2 triple.
	find /root/.pub-cache -path "*/cargokit/build_tool/lib/src/target.dart" \
		-exec sed -i \
			-e "s/'x86_64-unknown-linux-gnu'/'x86_64-t2-linux-gnu'/g" \
			{} \;

	# Build the Linux release bundle. flutter_rust_bridge will invoke
	# cargo internally to compile the Rust library.
	flutter build linux --release
}

localsend_install() {
	local cpu
	case $arch in
	x86-64) cpu=x64   ;;
	arm64)  cpu=arm64  ;;
	esac

	local bundle=$builddir/localsend-$ver/app/build/linux/$cpu/release/bundle

	install -d $root/$prefix
	cp -a $bundle/. $root/$prefix/

	chmod 755 $root/$prefix/localsend_app

	# Desktop entry
	install -d $root/usr/share/applications
	cat > $root/usr/share/applications/localsend.desktop << 'EOF'
[Desktop Entry]
Name=LocalSend
Comment=Share files to nearby devices
Exec=/opt/localsend/localsend_app %u
Icon=localsend
Type=Application
Categories=Network;FileTransfer;
MimeType=x-scheme-handler/localsend;
EOF

	# Install icon if present in the source tree
	local icon=$builddir/localsend-$ver/app/assets/img/logo-512.png
	if [ -f $icon ]; then
		install -Dm644 $icon $root/usr/share/pixmaps/localsend.png
	fi

	install -d $root/usr/bin
	ln -sf /$prefix/localsend_app $root/usr/bin/localsend
}

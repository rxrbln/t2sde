# --- T2-COPYRIGHT-BEGIN ---
# t2/package/*/localsend/localsend.conf
# Copyright (C) 2026 The T2 SDE Project
# SPDX-License-Identifier: GPL-2.0
# --- T2-COPYRIGHT-END ---

localsend_build() {
	# Flutter and Rust must be in PATH for the build.
	# cargo lives in /usr/bin on T2; /opt/rust/bin has rustc/rustdoc.
	export PATH="/opt/flutter/bin:/opt/rust/bin:/usr/bin:$PATH"
	export CARGO_HOME="$builddir/.cargo"

	local cpu
	case $arch in
	x86-64) cpu=x64   ;;
	arm64)  cpu=arm64  ;;
	*)      echo "Unsupported arch: $arch"; return 1 ;;
	esac

	cd $builddir/localsend-$ver/app

	# flutter_localizations (Flutter 3.38+) requires path >=1.9.1.
	# Relax the lower bound so pub can pick a compatible version.
	sed -i 's/^\( *path:\) 1\.9\.0$/\1 ^1.9.0/' pubspec.yaml

	# Fetch Dart package dependencies from pub.dev.
	flutter pub get

	# Build the Linux release bundle. flutter_rust_bridge will invoke
	# cargo internally to compile the Rust library.
	flutter build linux --release
}

localsend_install() {
	local cpu
	case $arch in
	x86-64) cpu=x64   ;;
	arm64)  cpu=arm64  ;;
	esac

	local bundle=$builddir/localsend-$ver/app/build/linux/$cpu/release/bundle

	install -d $root/$prefix
	cp -a $bundle/. $root/$prefix/

	chmod 755 $root/$prefix/localsend_app

	# Desktop entry
	install -d $root/usr/share/applications
	cat > $root/usr/share/applications/localsend.desktop << 'EOF'
[Desktop Entry]
Name=LocalSend
Comment=Share files to nearby devices
Exec=/opt/localsend/localsend_app %u
Icon=localsend
Type=Application
Categories=Network;FileTransfer;
MimeType=x-scheme-handler/localsend;
EOF

	# Install icon if present in the source tree
	local icon=$builddir/localsend-$ver/app/assets/img/logo-512.png
	if [ -f $icon ]; then
		install -Dm644 $icon $root/usr/share/pixmaps/localsend.png
	fi

	install -d $root/usr/bin
	ln -sf /$prefix/localsend_app $root/usr/bin/localsend
}

# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# T2 SDE: package/.../rtai/pkg_linux26_post.conf
# Copyright (C) 2007 The T2 SDE Project
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- T2-COPYRIGHT-NOTE-END ---

# TODO:
# rewrite this file to get rid of AWFUL hardlinks;
# make it easier to update to new rtai/linux version

# TODO:
# patch procedure should be more flexible to support different architectures
# and kernel versions

patch_linux() 
{
    echo '------------------------------------'
    echo 'Applying RTAI patch'
    echo '------------------------------------'
    tar $taropt `match_source_file -p rtai rtai` -C ../
    patch -p1 < ../rtai-3.5-cv/base/arch/i386/patches/hal-linux-2.6.19-i386-1.7-01.patch
}    

make_rtai() 
{    
    echo '--------------------------------------------'
    echo 'Entering make_rtai function'
    echo '--------------------------------------------'

#TODO: remove hardlinks
    pushd ../rtai-3.5-cv
    cp $base/package/*/rtai/.rtai_config ./.rtai_config

    # var_remove_regex confopt ' ' '--prefix=.*'
    confopt=""    
#	var_append confopt ' ' "--datadir=$root"
#	var_append confopt ' ' "--prefix=$root/$prefix/realtime"
#	var_append confopt ' ' "--with-rtai-dir=$root/usr/include"
	var_append confopt ' ' "--with-linux-dir=$kerneldir"
	var_append confopt ' ' "--build=$arch_build"
	var_append confopt ' ' "--host=$arch_target"    

    eval_config_command $confopt
    eval $MAKE
    eval $MAKE install DESTDIR=$root
    popd

    echo '$PATH="/usr/realtime/bin:$PATH"' > $root/etc/profile.d/rtai
}

# TODO:
# The function below should only be enabled when comedi-driver package selected
# to be compiled with RTAI support

make_rtai_with_comedi() 
{
    echo '--------------------------------------------'
    echo 'Entering make_rtai_with_comedi function'
    echo '--------------------------------------------'

    #TODO: remove hardlink
	pushd ../rtai-3.5-cv
	cp $base/package/*/rtai/.rtai_config_comedi ./.rtai_config

	confopt=""
#	var_append confopt ' ' "--prefix=/$prefix/realtime"
	var_append confopt ' ' "--with-linux-dir=$kerneldir"
#	var_append confopt ' ' "--with-module-dir=$root/lib/modules/"
	var_append confopt ' ' "--build=$arch_build"
	var_append confopt ' ' "--host=$arch_target"
	var_append confopt ' ' "--enable-comedi-lxrt"
#	var_append confopt ' ' "--with-comedi=/$prefix"
	var_append confopt ' ' "--with-comedi=$root/usr"
	
	eval_config_command $confopt
	eval $MAKE
	eval $MAKE install DESTDIR=$root
	
popd
}

hook_add postpatch 1 patch_linux
hook_add postmake 2 make_rtai
hook_add postmake 4 make_rtai_with_comedi

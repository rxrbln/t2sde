# --- T2-COPYRIGHT-BEGIN ---
# t2/package/*/nvidia-open/postlinux.conf
# Copyright (C) 2004 - 2025 The T2 SDE Project
# SPDX-License-Identifier: GPL-2.0
# --- T2-COPYRIGHT-END ---

# The kernel for this system is built with clang; match it.
# Use CC from the kernel build environment if set, fall back to clang.
nv_cc="${KCC:-${CC}}"
case "$nv_cc" in
    *clang*) ;;
    *) nv_cc="clang" ;;
esac

var_append makeopt ' ' "CC=$nv_cc"
var_append makeopt ' ' "SYSSRC=$kerneldir KERNEL_MODLIB=$moduledir"
var_append makeopt ' ' "KERNEL_UNAME=$lx_kernelrelease"
var_append makeopt ' ' "INSTALL_MOD_PATH=$root"

# Module.symvers may be absent when building against a pre-built kernel;
# treat undefined symbols as warnings rather than hard errors.
var_append makeopt ' ' "KBUILD_MODPOST_WARN=1"
var_append makeopt ' ' "IGNORE_CC_MISMATCH=1"
var_append makeopt ' ' "IGNORE_MISSING_MODULE_SYMVERS=1"

# nvidia-uvm requires make_device_exclusive_range() which was removed in
# kernel 6.16. Skip it â€” CUDA UVM is not needed for display/GL/Vulkan.
var_append makeopt ' ' "NV_KERNEL_MODULES=\"nvidia nvidia-modeset nvidia-drm\""

makeinstopt="$makeopt modules_install"

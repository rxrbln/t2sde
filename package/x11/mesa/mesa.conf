# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# T2 SDE: package/.../mesa/mesa.conf
# Copyright (C) 2008 - 2020 The T2 SDE Project
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- T2-COPYRIGHT-NOTE-END ---

mesa_compat_symlinks() {
    # some compat symlinks (needed e.g. for (free)glut)
    (
	cd $root/usr/lib
	ln -sdfv ../X11/include/GL $root/usr/include/GL
	ln -sfv ../X11/${libdir##*/}/libGL.* .
	ln -sfv ../X11/${libdir##*/}/libGLU.* .
    )
}
hook_add postmake 5 mesa_compat_symlinks

if atstage cross; then
	var_append GCC_WRAPPER_INSERT ' ' "-I$root/usr/X11R7/include/libdrm"
	var_append GCC_WRAPPER_INSERT ' ' "-L$root/usr/X11R7/lib"
else
	#CXX_WRAPPER_BYPASS=1
	:
fi

dridrv="r100,r200"
galdrv="r600,swrast,nouveau"
vuldrv=""
case "$arch" in
x86*)
	var_append dridrv ',' "i965"
	var_append galdrv ',' "i915,svga"
	;;
sparc*)
	var_append GCC_WRAPPER_INSERT ' ' '-c?:-latomic -Wl,--as-needed'
	;;
esac

if pkginstalled llvm; then
	var_append mesonopt ' ' '-Dllvm=true -Dshared-llvm=true' # --enable-opencl
	var_append galdrv ',' "r300,radeonsi"
	var_append vuldrv ',' "amd"
	if [[ $arch = x86* ]]; then
		var_append galdrv ',' "r300,radeonsi,iris"
		var_append vuldrv ',' "intel"
	fi
else
	var_append traconfopt ' ' '-Dllvm=false'
fi

var_append mesonopt ' ' "-Dosmesa=gallium -Ddri-drivers=$dridrv -Dgallium-drivers=$galdrv"
[ "$vuldrv" ] && var_append mesonopt ' ' "-D=vulkan-drivers=$vuldrv"
var_append mesonopt ' ' '-Degl=true -Dgbm=true' # --enable-glx-tls
var_append mesonopt ' ' '-Dplatforms=x11,drm -Dgles1=true -Dgles2=true'
var_append mesonopt ' ' '-Dgbm=true -Dshared-glapi=true -Ddr=auto -Dglx=auto' # --enable-openvg
var_append mesonopt ' ' '-Dgallium-xa=true -Dosmesa=gallium' # --enable-texture-float
#pkginstalled dri3proto || var_append mesonopt ' ' '-Ddri3=true'

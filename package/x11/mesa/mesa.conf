# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by scripts/Create-CopyPatch.
# 
# T2 SDE: package/*/mesa/mesa.conf
# Copyright (C) 2008 - 2021 The T2 SDE Project
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- T2-COPYRIGHT-NOTE-END ---

mesa_compat_symlinks() {
    # some compat symlinks (needed e.g. for (free)glut)
    (
	cd $root/usr/lib
	ln -sdfv ../X11/include/GL $root/usr/include/GL
	ln -sfv ../X11/${libdir##*/}/libGL.* .
	ln -sfv ../X11/${libdir##*/}/libGLU.* .
    )
}
hook_add postmake 5 mesa_compat_symlinks

if atstage cross; then
	# translate native llvm-config libraries to sysroot
	var_append GCC_WRAPPER_FILTER '|' "sed 's,$root/TOOLCHAIN.*libLLVM\(.*\)\.[as].*,-lLLVM\1,g'"
	# remove native llvm-config include
	var_append GCC_WRAPPER_REMOVE ' ' "-I$root/TOOLCHAIN/tools.cross/include"
	var_append GCC_WRAPPER_REMOVE ' ' "-L$root/TOOLCHAIN/tools.cross/lib"
fi

[[ $arch = sparc* ]] && var_append GCC_WRAPPER_INSERT ' ' '-c?:-latomic -Wl,--as-needed'

dridrv=
galdrv=swrast
vuldrv=
platforms= # drm

pkginstalled libx11 && var_append platforms ',' 'x11'
pkginstalled wayland && var_append platforms ',' 'wayland'

if pkginstalled libdrm; then
    var_append mesonopt ' ' '-Ddri=auto -Degl=enabled'
    var_append mesonopt ' ' '-Dplatforms=$platforms -Dgles1=enabled -Dgles2=enabled'

    dridrv="r100,r200"
    galdrv="r600,nouveau,virgl,zink"
    case "$arch" in
    x86)
	var_append dridrv ',' "i965"
	var_append galdrv ',' "svga"
	;;
    x86-64)
	var_append dridrv ',' "i965"
	var_append galdrv ',' "i915,svga"
	;;
    esac
else
    var_append mesonopt ' ' '-Ddri=disabled'
fi

if pkginstalled llvm; then
    var_append mesonopt ' ' '-Dllvm=enabled -Dshared-llvm=enabled'
    var_append mesonopt ' ' '-Dosmesa=gallium'

    if pkginstalled libdrm; then
	var_append mesonopt ' ' '-Dgallium-xa=enabled'

	var_append galdrv ',' "r300,radeonsi"
	var_append vuldrv ',' "amd"
	case $arch in
	x86-64)
		var_append galdrv ',' "iris"
		var_append vuldrv ',' "intel"
		;;
	arm*)
		var_append galdrv ',' "kmsro,etnaviv,freedreno,lima,panfrost,v3d,vc4,tegra"
		var_append vuldrv ',' "freedreno"
		[ $arch = arm ] && var_remove galdrv ',' 'v3d,vc4'
		;;
	esac
    fi
else
	var_append mesonopt ' ' '-Dllvm=false -Dosmesa=classic'
fi

pkginstalled vulkan-headers || var_remove galdrv ',' 'zink'

var_append mesonopt ' ' "-Dvulkan-drivers=$vuldrv"
var_append mesonopt ' ' "-Ddri-drivers=$dridrv -Dgallium-drivers=$galdrv"
var_append mesonopt ' ' '-Dgbm=enabled -Dshared-glapi=enabled -Dglx=auto'

# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# T2 SDE: package/.../jabberd/jabberd.conf
# Copyright (C) 2004 - 2005 The T2 SDE Project
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- T2-COPYRIGHT-NOTE-END ---

# Jabber wants its own directory with the proper group rights.
prefix=opt/jabber
set_confopt

extraincdir=""
extralibdir="" 

# enable ssl when available.
pkginstalled openssl && var_append extraconfopt " " "--enable-ssl"
pkginstalled openssl || var_append extraconfopt " " "--enable-ssl"

# Enable idn when available.
pkginstalled libidn && var_append extraconfopt " " "--enable-idn"
pkginstalled libidn || var_append extraconfopt " " "--enable-idn"

# Add database support if database package is available.
pkginstalled mysql && var_append extraconfopt " " "--enable-mysql"
pkginstalled mysql || var_append extraconfopt " " "--disable-mysql"
pkginstalled postgresql && var_append extraconfopt " " "--enable-pgsql"
pkginstalled postgresql || var_append extraconfopt " " "--disable-pgsql"
pkginstalled bdb && var_append extraconfopt " " "--enable-db"
pkginstalled bdb || var_append extraconfopt " " "--disable-db"

# Add available authentication support.
pkginstalled pam && var_append extraconfopt " " "--enable-pam"
pkginstalled pam || var_append extraconfopt " " "--enable-pam"
if pkginstalled openldap; then
	var_append extraconfopt " " "--enable-ldap"
	var_append extraincdir ":" "$(pkgprefix includedir)" 
	var_append extralibdir ":" "$(pkgprefix libdir)" 
else
	var_append extraconfopt " " "--disable-ldap"
fi

# Add additional include dirs if available.
if [ -n $extraincdir ]; then
	# Now add the extra include dirs to the configure
	# options, but make sure to strip the first :
	var_append extraconfopt " " "--with-extra-include-path=${extraincdir:1}"
fi

# Same for additional library dirs.
if [ -n $extralibdir ]; then
	# Now add the extra library dirs to the configure
	# options, but make sure to strip the first :
	var_append extraconfopt " " "--with-extra-library-path=${extralibdir:1}"
fi

jabber_preconf() {
	# Make sure the prefix directory has the proper access rights.
	chgrp jabber $root/$prefix 
	chmod a+rx,g+ws $root/$prefix 

	# Also ensure the state dir has the proper access rights.
	chgrp jabber $localstatedir 
	chmod a+rx,g+ws $localstatedir 
}

jabber_postmake() {
	# Todo: init probably needs more work. The jabberd CVS contains
	#       an example look at:
	# http://www.jabberstudio.org/cgi-bin/viewcvs.cgi/jabberd2/tools/
	install_init jabberd $confdir/jabberd.init
}

hook_add preconf 5 "jabber_preconf"
hook_add postmake 5 "jabber_postmake"

# --- ROCK-COPYRIGHT-NOTE-BEGIN ---
# 
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# Please add additional copyright information _after_ the line containing
# the ROCK-COPYRIGHT-NOTE-END tag. Otherwise it might get removed by
# the ./scripts/Create-CopyPatch script. Do not edit this copyright text!
# 
# ROCK Linux: rock-src/package/*/samba/samba.conf
# Copyright (C) 1998 - 2003 ROCK Linux Project
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version. A copy of the GNU General Public
# License can be found at Documentation/COPYING.
# 
# Many people helped and are helping developing ROCK Linux. Please
# have a look at http://www.rocklinux.org/ and the Documentation/TEAM
# file for details.
# 
# --- ROCK-COPYRIGHT-NOTE-END ---

if [ $prefix_auto = 1 ] ; then
	prefix="opt/samba"
	set_confopt
fi

var_append extraconfopt " " "--with-smbmount --with-automount \
--with-syslog --with-configdir=$sysconfdir \
--with-privatedir=$sysconfdir/private --with-codepagedir=$sysconfdir/codepages \
--with-swatdir=$root/$prefix/share/swat --with-quotas \
--with-acl-support --with-libsmbclient"

[ "$arch" = x86 -a "$ROCKCFG_X86_BITS" = "64" ] || 
	var_append extraconfopt ' ' "--with-spinlocks"

# pam support
pkginstalled pam && var_append extraconfopt ' ' "--with-pam --with-pam_smbpass"

# enable nis+ support
var_append extraconfopt ' ' "--with-nisplus-home"

# let samba configure find ldap and enable ldapsam
if pkginstalled openldap; then
	var_append extraconfopt ' ' "--with-ldapsam"
	var_append extraconfopt ' ' "CFLAGS=\"$CFLAGS${CFLAGS:+ }-I$root/$pkg_openldap_prefix/include\""
	var_append extraconfopt ' ' "CPPFLAGS=\"$CPPFLAGS${CPPFLAGS:+ }-I$root/$pkg_openldap_prefix/include\""
	var_append extraconfopt ' ' "LDFLAGS=\"$LDFLAGS${LDFLAGS:+ }-L$root/$pkg_openldap_prefix/lib\""
fi

samba_pm ()
{
	install_init samba $confdir/samba.init
	install_init smbmount $confdir/smbmount.init

	[ -d $root/usr/lib/cups/backend/ ] && \
		ln -sf $bindir/smbspool $root/usr/lib/cups/backend/smb
 
	cp -vf smbadduser $bindir ; chmod 755 $bindir/smbadduser

	cd ..
	sed 's/;  encrypt passwords = yes/  encrypt passwords = yes/' \
		examples/smb.conf.default > $docdir/smb.conf

	cat > $sysconfdir/lmhosts <<'EOS'
# ROCK Linux: Samba lmhosts
#
# This file contains host maps for NetBIOS
# It is similar to the /etc/hosts file format
# See lmhosts (5) for more info.
#
# Format is:
# 0.0.0.0 NetBIOS_Name

EOS
	
	# xinetd integration readme
	sed "s,D_sbindir,$sbindir," < $confdir/README.xinetd > $docdir/README.xinetd
}

srcdir="samba-$ver/source"
hook_add postmake 3 "samba_pm"
hook_add postmake 3 "echo \"pkg_samba_prefix=/$prefix\" \
        > $root/var/adm/parse-config/samba"


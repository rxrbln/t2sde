# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# T2 SDE: package/.../samba/samba.conf
# Copyright (C) 2004 - 2014 The T2 SDE Project
# Copyright (C) 1998 - 2003 ROCK Linux Project
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- T2-COPYRIGHT-NOTE-END ---


if [ $prefix_auto = 1 ] ; then
        if [ "$SDECFG_PKG_SAMBA_CORE_PREFIX" ] ; then
                prefix="$SDECFG_PKG_SAMBA_CORE_PREFIX"
          else
                prefix="opt/samba"
         fi
        set_confopt
fi

var_append extraconfopt " " "--with-smbmount --with-automount \
--with-syslog --with-configdir=$sysconfdir \
--with-privatedir=$sysconfdir/private --with-codepagedir=$sysconfdir/codepages \
--with-swatdir=$datadir/swat --with-quotas \
--with-acl-support --with-libsmbclient --with-cifsmount"

if atstage cross; then
	hook_add preconf 5 "echo 'samba_cv_CC_NEGATIVE_ENUM_VALUES=yes
samba_cv_have_setresuid=yes
samba_cv_USE_SETRESUID=yes' >> ./config.cache"
	# guide not to pick up host's CUPS, ...
	pkginstalled cups || var_append extraconfopt ' ' '--disable-cups'
fi

# building with enabled spinlocks fails for tdbbackup with 'unresolved symbol this_is_smp',
# use the default fcntl locking
#case $arch in
#	x86|sparc|powerpc) var_append extraconfopt ' ' '--with-spinlocks' ;;
#esac

# pam support
pkginstalled pam && atstage native && var_append extraconfopt ' ' "--with-pam --with-pam_smbpass"

# enable nis+ support
var_append extraconfopt ' ' "--with-nisplus-home"

# let samba configure find ldap and enable ldapsam
if pkginstalled openldap; then
	pkgprefix -t openldap
	var_append extraconfopt ' ' "--with-ldapsam"
	var_append extraconfopt ' ' "CFLAGS=\"$CFLAGS${CFLAGS:+ }-I$( pkgprefix includedir openldap )\""
	var_append extraconfopt ' ' "CPPFLAGS=\"$CPPFLAGS${CPPFLAGS:+ }-I$( pkgprefix includedir openldap )\""
	var_append extraconfopt ' ' "LDFLAGS=\"$LDFLAGS${LDFLAGS:+ }-L$( pkgprefix libdir openldap )\""
fi

samba_pm ()
{
	# FIXME: this should be down with pkgprefix libdir cups
	[ -d $root/usr/lib/cups/backend/ ] && \
		ln -sf $bindir/smbspool $root/usr/lib/cups/backend/smb
 
	chmod 755 smbadduser; cp -vf smbadduser $root$bindir

	cd ..
	sed 's/;  encrypt passwords = yes/  encrypt passwords = yes/' \
		examples/smb.conf.default > $root$docdir/smb.conf

	cat > $root$sysconfdir/lmhosts <<'EOS'
# T2: Samba lmhosts
#
# This file contains host maps for NetBIOS
# It is similar to the /etc/hosts file format
# See lmhosts (5) for more info.
#
# Format is:
# 0.0.0.0 NetBIOS_Name

EOS
	
	# xinetd integration readme
	sed "s,D_sbindir,$sbindir," < $confdir/README.xinetd > $root$docdir/README.xinetd
}

hook_add preconf 2 "cd source3"

hook_add postmake 3 "samba_pm"

# install examples
hook_add postmake 5 "cp -vRf examples $root$docdir/"

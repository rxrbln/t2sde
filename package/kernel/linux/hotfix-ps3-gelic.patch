# --- T2-COPYRIGHT-BEGIN ---
# t2/package/*/linux/hotfix-ps3-gelic.patch
# Copyright (C) 2025 The T2 SDE Project
# SPDX-License-Identifier: GPL-2.0 or patched project license
# --- T2-COPYRIGHT-END ---

Since some MM rework around 5.x the ps3 gelic ethernet driver quickly runs
out of memory to allocate. Fix this by gracefully handling SKB allocation
failures, and keep napi polling. To improve performance, use napi* functions
instead of net* to receive and allocate SKBs.

Before:	[  5]   0.00-10.00  sec   752 MBytes   631 Mbits/sec  3917             sender
After:	[  5]   0.00-10.00  sec  1.09 GBytes   940 Mbits/sec   40             sender

Signed-off-by: Florian Fuchs <fuchsfl@gmail.com>
Tested-By: Ren√© Rebe <rene@exactcode.de>

--- linux-6.18/drivers/net/ethernet/toshiba/ps3_gelic_net.c.vanilla	2025-12-12 18:45:10.354433287 +0100
+++ linux-6.18/drivers/net/ethernet/toshiba/ps3_gelic_net.c	2025-12-12 18:47:43.313208820 +0100
@@ -374,7 +374,8 @@
  * must be a multiple of GELIC_NET_RXBUF_ALIGN.
  */
 static int gelic_descr_prepare_rx(struct gelic_card *card,
-				  struct gelic_descr *descr)
+				  struct gelic_descr *descr,
+				  bool napi_mode)
 {
 	static const unsigned int rx_skb_size =
 		ALIGN(GELIC_NET_MAX_FRAME, GELIC_NET_RXBUF_ALIGN) +
@@ -392,7 +393,10 @@
 	descr->hw_regs.payload.dev_addr = 0;
 	descr->hw_regs.payload.size = 0;
 
-	descr->skb = netdev_alloc_skb(*card->netdev, rx_skb_size);
+	if (napi_mode)
+		descr->skb = napi_alloc_skb(&card->napi, rx_skb_size);
+	else
+		descr->skb = netdev_alloc_skb(*card->netdev, rx_skb_size);
 	if (!descr->skb) {
 		descr->hw_regs.payload.dev_addr = 0; /* tell DMAC don't touch memory */
 		return -ENOMEM;
@@ -464,7 +468,7 @@
 
 	do {
 		if (!descr->skb) {
-			ret = gelic_descr_prepare_rx(card, descr);
+			ret = gelic_descr_prepare_rx(card, descr, false);
 			if (ret)
 				goto rewind;
 		}
@@ -964,7 +968,7 @@
 	netdev->stats.rx_bytes += skb->len;
 
 	/* pass skb up to stack */
-	netif_receive_skb(skb);
+	napi_gro_receive(&card->napi, skb);
 }
 
 /**
@@ -1069,7 +1073,7 @@
 	/*
 	 * this call can fail, propagate the error
 	 */
-	prepare_rx_ret = gelic_descr_prepare_rx(card, descr);
+	prepare_rx_ret = gelic_descr_prepare_rx(card, descr, true);
 	if (prepare_rx_ret)
 		return prepare_rx_ret;
 

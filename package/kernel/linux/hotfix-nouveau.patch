# --- T2-COPYRIGHT-BEGIN ---
# t2/package/*/linux/hotfix-nouveau.patch
# Copyright (C) 2025 The T2 SDE Project
# SPDX-License-Identifier: GPL-2.0 or patched project license
# --- T2-COPYRIGHT-END ---

Jul 25 15:29:40 t2 kernel: Hardware name: PowerMac11,2 PPC970MP 0x440101 PowerMac
...
Jul 25 15:29:40 t2 kernel: nouveau 0000:0a:00.0: drm: 0x14C5: Parsing digital output script table
Jul 25 15:29:40 t2 kernel: BUG: Unable to handle kernel data access on read at 0x00041520
Jul 25 15:29:40 t2 kernel: Faulting instruction address: 0xc0003d0001be0844
Jul 25 15:29:40 t2 kernel: Oops: Kernel access of bad area, sig: 11 [#1]
Jul 25 15:29:40 t2 kernel: BE PAGE_SIZE=4K MMU=Hash  SMP NR_CPUS=8 NUMA PowerMac
Jul 25 15:29:40 t2 kernel: Modules linked in: windfarm_cpufreq_clamp windfarm_smu_sensors windfarm_smu_controls windfarm_pm112 snd_aoa_codec_onyx snd_aoa_fabric_layout snd_aoa windfarm_pid jo
ydev evdev mousedev mac_hid apple_mfi_fastcharge rndis_host cdc_ether usbnet mii snd_aoa_i2sbus snd_aoa_soundbus snd_pcm snd_timer snd soundcore rack_meter windfarm_smu_sat windfarm_max6690_s
ensor nouveau(+) windfarm_lm75_sensor windfarm_core gpu_sched drm_gpuvm drm_exec drm_client_lib drm_ttm_helper ttm drm_display_helper drm_kms_helper drm drm_panel_orientation_quirks syscopyar
ea sysfillrect sysimgblt fb_sys_fops i2c_algo_bit backlight uio_pdrv_genirq uio uninorth_agp agpgart zram dm_mod dax ipv6 nfsv4 dns_resolver nfs lockd grace sunrpc offb cfbfillrect cfbimgblt
fb_io_fops cfbcopyarea fb font input_leds sr_mod cdrom sd_mod uas ata_generic hid_apple hid_generic usbhid hid usb_storage pata_macio sata_svw libata firewire_ohci scsi_mod firewire_core ohci
_pci crc_itu_t scsi_common ehci_pci ehci_hcd tg3 ohci_hcd libphy usbcore usb_common nls_base
Jul 25 15:29:40 t2 kernel:  led_class
Jul 25 15:29:40 t2 kernel: CPU: 0 UID: 0 PID: 245 Comm: (udev-worker) Not tainted 6.14.0-09584-g7d06015d936c #7 PREEMPTLAZY
Jul 25 15:29:40 t2 kernel: Hardware name: PowerMac11,2 PPC970MP 0x440101 PowerMac
Jul 25 15:29:40 t2 kernel: NIP:  c0003d0001be0844 LR: c0003d0001be0830 CTR: 0000000000000000
Jul 25 15:29:40 t2 kernel: REGS: c0000000053f70e0 TRAP: 0300   Not tainted  (6.14.0-09584-g7d06015d936c)
Jul 25 15:29:40 t2 kernel: MSR:  9000000000009032 <SF,HV,EE,ME,IR,DR,RI>  CR: 24222220  XER: 00000000
Jul 25 15:29:40 t2 kernel: DAR: 0000000000041520 DSISR: 40000000 IRQMASK: 0 \x0aGPR00: c0003d0001be0830 c0000000053f7380 c0003d0000911900 c000000007bc6800 \x0aGPR04: 0000000000000000 0000000000000000 c000000007bc6e70 0000000000000001 \x0aGPR08: 01f3040000000000 0000000000041520 0000000000000000 c0003d0000813958 \x0aGPR12: c000000000071a48 c000000000e28000 0000000000000020 0000000000000000 \x0aGPR16: 0000000000000000 0000000000f52630 0000000000000000 0000000000000000 \x0aGPR20: 0000000000000000 0000000000000000 0000000000000001 c0003d0000928528 \x0aGPR24: c0003d0000928598 0000000000000000 c000000007025480 c000000007025480 \x0aGPR28: c0000000010b4000 0000000000000000 c000000007bc1800 c000000007bc6800
Jul 25 15:29:40 t2 kernel: NIP [c0003d0001be0844] nv_crtc_destroy+0x44/0xd4 [nouveau]
Jul 25 15:29:40 t2 kernel: LR [c0003d0001be0830] nv_crtc_destroy+0x30/0xd4 [nouveau]
Jul 25 15:29:40 t2 kernel: Call Trace:
Jul 25 15:29:40 t2 kernel: [c0000000053f7380] [c0003d0001be0830] nv_crtc_destroy+0x30/0xd4 [nouveau] (unreliable)
Jul 25 15:29:40 t2 kernel: [c0000000053f73c0] [c0003d00007f7bf4] drm_mode_config_cleanup+0x27c/0x30c [drm]
Jul 25 15:29:40 t2 kernel: [c0000000053f7490] [c0003d0001bdea50] nouveau_display_create+0x1cc/0x550 [nouveau]
Jul 25 15:29:40 t2 kernel: [c0000000053f7500] [c0003d0001bcc29c] nouveau_drm_device_init+0x1c8/0x844 [nouveau]
Jul 25 15:29:40 t2 kernel: [c0000000053f75e0] [c0003d0001bcc9ec] nouveau_drm_probe+0xd4/0x1e0 [nouveau]
Jul 25 15:29:40 t2 kernel: [c0000000053f7670] [c000000000557d24] local_pci_probe+0x50/0xa8
Jul 25 15:29:40 t2 kernel: [c0000000053f76f0] [c000000000557fa8] pci_device_probe+0x22c/0x240
Jul 25 15:29:40 t2 kernel: [c0000000053f7760] [c0000000005fff3c] really_probe+0x188/0x31c
Jul 25 15:29:40 t2 kernel: [c0000000053f77e0] [c000000000600204] __driver_probe_device+0x134/0x13c
Jul 25 15:29:40 t2 kernel: [c0000000053f7860] [c0000000006002c0] driver_probe_device+0x3c/0xb4
Jul 25 15:29:40 t2 kernel: [c0000000053f78a0] [c000000000600534] __driver_attach+0x118/0x128
Jul 25 15:29:40 t2 kernel: [c0000000053f78e0] [c0000000005fe038] bus_for_each_dev+0xa8/0xf4
Jul 25 15:29:40 t2 kernel: [c0000000053f7950] [c0000000005ff460] driver_attach+0x2c/0x40
Jul 25 15:29:40 t2 kernel: [c0000000053f7970] [c0000000005fea68] bus_add_driver+0x130/0x278
Jul 25 15:29:40 t2 kernel: [c0000000053f7a00] [c00000000060117c] driver_register+0x9c/0x1a0
Jul 25 15:29:40 t2 kernel: [c0000000053f7a80] [c00000000055623c] __pci_register_driver+0x5c/0x70
Jul 25 15:29:40 t2 kernel: [c0000000053f7aa0] [c0003d0001c058a0] nouveau_drm_init+0x254/0x278 [nouveau]
Jul 25 15:29:40 t2 kernel: [c0000000053f7b10] [c00000000000e9bc] do_one_initcall+0x84/0x268
Jul 25 15:29:40 t2 kernel: [c0000000053f7bf0] [c0000000001a0ba0] do_init_module+0x70/0x2d8
Jul 25 15:29:40 t2 kernel: [c0000000053f7c70] [c0000000001a42bc] init_module_from_file+0xb4/0x108
Jul 25 15:29:40 t2 kernel: [c0000000053f7d50] [c0000000001a4504] sys_finit_module+0x1ac/0x478
Jul 25 15:29:40 t2 kernel: [c0000000053f7e10] [c000000000023230] system_call_exception+0x1a4/0x20c
Jul 25 15:29:40 t2 kernel: [c0000000053f7e50] [c00000000000c554] system_call_common+0xf4/0x258
Jul 25 15:29:40 t2 kernel: --- interrupt: c00 at 0xfd5f988
Jul 25 15:29:40 t2 kernel: NIP:  000000000fd5f988 LR: 000000000ff9b148 CTR: 0000000000000000
Jul 25 15:29:40 t2 kernel: REGS: c0000000053f7e80 TRAP: 0c00   Not tainted  (6.14.0-09584-g7d06015d936c)
Jul 25 15:29:40 t2 kernel: MSR:  100000000000d032 <HV,EE,PR,ME,IR,DR,RI>  CR: 28222244  XER: 00000000
Jul 25 15:29:40 t2 kernel: IRQMASK: 0 \x0aGPR00: 0000000000000161 00000000ffcdc2d0 00000000405db160 0000000000000020 \x0aGPR04: 000000000ffa2c9c 0000000000000000 000000000000001f 0000000000000045 \x0aGPR08: 0000000011a13770 0000000000000000 0000000000000000 0000000000000000 \x0aGPR12: 0000000000000000 0000000010249d8c 0000000000000020 0000000000000000 \x0aGPR16: 0000000000000000 0000000000f52630 0000000000000000 0000000000000000 \x0aGPR20: 0000000000000000 0000000000000000 0000000000000000 0000000011a11a70 \x0aGPR24: 0000000011a13580 0000000011a11950 0000000011a11a70 0000000000020000 \x0aGPR28: 000000000ffa2c9c 0000000000000000 000000000ffafc40 0000000011a11a70
Jul 25 15:29:40 t2 kernel: NIP [000000000fd5f988] 0xfd5f988
Jul 25 15:29:40 t2 kernel: LR [000000000ff9b148] 0xff9b148
Jul 25 15:29:40 t2 kernel: --- interrupt: c00
Jul 25 15:29:40 t2 kernel: Code: f821ffc1 418200ac e93f0000 e9290038 e9291468 eba90000 48026c0d e8410018 e93f06aa 3d290001 392982a4 79291f24 <7fdd482a> 2c3e0000 41820030 7fc3f378
Jul 25 15:29:40 t2 kernel: ---[ end trace 0000000000000000 ]---

commit a73583107af9b42c0a28045e4e30ec3fab2dbcd1
Author: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
Date:   Mon Jan 6 01:00:14 2025 +0200

    drm/nouveau: vendor in drm_encoder_slave API

    Nouveau driver is the only user of the drm_encoder_slave API. Rework
    necessary bits of drm_encoder_slave into the nouveau_i2c_encoder API and
    drop drm_encoder_slave.c from the DRM KMS helper.

--- linux-6.17/drivers/gpu/drm/nouveau/dispnv04/nouveau_i2c_encoder.c.vanilla	2025-11-24 16:07:19.903844145 +0100
+++ linux-6.17/drivers/gpu/drm/nouveau/dispnv04/nouveau_i2c_encoder.c	2025-11-24 16:07:33.244690359 +0100
@@ -94,26 +94,6 @@
 	return err;
 }
 
-/**
- * nouveau_i2c_encoder_destroy - Unregister the I2C device backing an encoder
- * @drm_encoder:	Encoder to be unregistered.
- *
- * This should be called from the @destroy method of an I2C slave
- * encoder driver once I2C access is no longer needed.
- */
-void nouveau_i2c_encoder_destroy(struct drm_encoder *drm_encoder)
-{
-	struct nouveau_i2c_encoder *encoder = to_encoder_i2c(drm_encoder);
-	struct i2c_client *client = nouveau_i2c_encoder_get_client(drm_encoder);
-	struct module *module = client->dev.driver->owner;
-
-	i2c_unregister_device(client);
-	encoder->i2c_client = NULL;
-
-	module_put(module);
-}
-EXPORT_SYMBOL(nouveau_i2c_encoder_destroy);
-
 /*
  * Wrapper fxns which can be plugged in to drm_encoder_helper_funcs:
  */
--- linux-6.17/drivers/gpu/drm/nouveau/include/dispnv04/i2c/encoder_i2c.h.vanilla	2025-11-24 16:10:48.602806488 +0100
+++ linux-6.17/drivers/gpu/drm/nouveau/include/dispnv04/i2c/encoder_i2c.h	2025-11-24 16:14:07.759809732 +0100
@@ -202,7 +202,24 @@
 	return to_encoder_i2c(encoder)->i2c_client;
 }
 
-void nouveau_i2c_encoder_destroy(struct drm_encoder *encoder);
+/**
+ * nouveau_i2c_encoder_destroy - Unregister the I2C device backing an encoder
+ * @drm_encoder:        Encoder to be unregistered.
+ *
+ * This should be called from the @destroy method of an I2C slave
+ * encoder driver once I2C access is no longer needed.
+ */
+static __always_inline void nouveau_i2c_encoder_destroy(struct drm_encoder *drm_encoder)
+{
+	struct nouveau_i2c_encoder *encoder = to_encoder_i2c(drm_encoder);
+	struct i2c_client *client = nouveau_i2c_encoder_get_client(drm_encoder);
+	struct module *module = client->dev.driver->owner;
+
+	i2c_unregister_device(client);
+	encoder->i2c_client = NULL;
+
+	module_put(module);
+}
 
 /*
  * Wrapper fxns which can be plugged in to drm_encoder_helper_funcs:

# --- ROCK-COPYRIGHT-NOTE-BEGIN ---
# 
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# Please add additional copyright information _after_ the line containing
# the ROCK-COPYRIGHT-NOTE-END tag. Otherwise it might get removed by
# the ./scripts/Create-CopyPatch script. Do not edit this copyright text!
# 
# ROCK Linux: rock-src/misc/jailing/parse-config
# ROCK Linux is Copyright (C) 1998 - 2003 Clifford Wolf
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version. A copy of the GNU General Public
# License can be found at Documentation/COPYING.
# 
# Many people helped and are helping developing ROCK Linux. Please
# have a look at http://www.rocklinux.org/ and the Documentation/TEAM
# file for details.
# 
# --- ROCK-COPYRIGHT-NOTE-END ---

jail_pkg_apache_postmake() {
	jail_ensure_users http

	### Updates paths in $datadir/build/config_vars.mk
	
	echo "Updateing paths in $datadir/build/config_vars.mk"
        tmp=`mktemp`

	# A copy of original config_vars.mk is left for reference
	cp $datadir/build/config_vars.mk $datadir/build/config_vars.mk.orig
        
	cp -f $datadir/build/config_vars.mk $tmp

	# s|$base/$builddir/httpd-$ver|/$jail/usr|; is repeated many times
	# because it appear many times in same line ... probably there is
	# a not so silly way but I can't find it :(
	# Feel free of cleaning it
        sed "   /^exp_.* = \/.*/ {s| = /*usr| = /$jail/usr|; \
			s| = /*etc| = /$jail/etc|; s| = /*var| = /$jail/var|; \
			p; d; }; \
                /^rel_.* = \/.*/ {s| = /*usr/| = |; s| = /*usr| = |; \
			s| = /*etc| = ../etc|; s| = /*var| = ../var|; p; d; }; \
		/ = \/.*/ {s| = /*usr| = /$jail/usr|; \
			s| = /*etc| = /$jail/etc|; s| = /*var| = /$jail/var|; \
			p; d; }; \
                " < $tmp > $datadir/build/config_vars.mk

	### END Updates paths in $datadir/build/config_vars.mk

	### Updates paths in $sbindir/apxs
        
	echo "Updateing paths in $sbindir/apxs"
	cp -f $sbindir/apxs $tmp
	sed "s|/usr/share/build|/$datadir/build|" < $tmp \
                                        > $sbindir/apxs

	### END Updates paths in $sbindir/apxs

	### Update apachectl

	echo "Updateing paths in $sbindir/apachectl"
	cp -f $sbindir/apachectl $tmp
	sed "s|HTTPD=.*|HTTPD='chroot /$jail ${sbindir/\/$jail}/httpd'|" \
					< $tmp > $sbindir/apachectl

	### END Update apachectl

	rm $tmp
        unset tmp
}

jail_pkg_postfix_postmake() {
	./postfix-install -non-interactive \
		daemon_directory=/usr/libexec command_directory=/usr/bin \
		sendmail_path=/usr/bin/sendmail \
		newaliases_path=/usr/bin/newaliases \
		mailq_path=/usr/bin/mailq manpage_directory=/man/ \
		sample_directory=/usr/share/$pkg
	jail_ensure_users postfix
	jail_ensure_groups postdrop
}

jail_pkg_mysql_postmake() {
	mv $libdir/mysql/* $libdir
	rmdir $libdir/mysql
	mv $root/$jail/usr/include/mysql/* $root/$jail/usr/include/
	rmdir $root/$jail/usr/include/mysql
	mkdir -p $docdir
	cp support-files/my-*.cnf $docdir
	chown $pkg.$pkg $localstatedir
}


# Revwrite --with-<option>=<pkg_path> in confopt
# to correct <path> when <option> is relative to
# a jailed package.
#
jail_confopt_paths_rewrite() {
	# This list will grow
	for y in mysql postgresql openldap apache; do
		if eval "[ \"\${ROCKCFG_JAILING_$y}\" = 1 ]" ; then
			# Correct eventual misconfigured jail
			# To be removed!
			if eval "[ ! \"\${ROCKCFG_JAILDIR_$y}\"  ]" ; then
				eval "export \${ROCKCFG_JAILDIR_$y}=\
					\"${ROCKCFG_BASEJAIL}/$y\""
			fi

                	eval "y_path=$root/\"\${ROCKCFG_JAILDIR_$y}/usr\""

			# Set correct optname and y_path
			# This will grow too
			case $y in
				postgresql) optname=pgsql ;;
				openldap) optname=ldap ;;
				apache) optname=apxs2
					y_path=${y_path}/sbin/apxs ;;
				*) optname=$y ;;
			esac

			case $pkg in
				dbmail) y_path=${y_path}/include/ ;;
			esac

			# Rewrite
			confopt=$(eval "echo $confopt" | xargs -n1 | sed " \
				s|^--with-${optname}=shared.*$|--with-${optname}=shared,${y_path}|g; \
				s|^--with-${optname}=[^,]*$|--with-${optname}=${y_path}|g; \
				" | xargs)

			# Sometime pkg has internal support for <optname> so
			# if there's no =... or =shared it means internal
			# support want to be used.
			# Only mysql in php is using this ... for now
			if [ ! "`echo ${has_internal} | grep $optname`" ] ; then
				confopt=$(echo $confopt | xargs -n1 | sed " \
					s|^--with-${optname}$|--with-${optname}=${y_path}|g \
					" | xargs)
			fi
		fi
	done
	unset y optname y_path
}


jail_samejail() {
	eval "export ROCKCFG_JAILING_$1=\"\$ROCKCFG_JAILING_$2\""
	eval "export ROCKCFG_JAILDIR_$1=\"\$ROCKCFG_JAILDIR_$2\""
}


if [ "${ROCKCFG_JAILING}" = 1 ]
then
	[ "$pkg" = php ] && jail_samejail php apache
	
	if eval "[ \"\${ROCKCFG_JAILING_$pkg}\" = 1 ]" ; then
		. $base/misc/jailing/jail-functions
		if eval "[ ! \"\${ROCKCFG_JAILDIR_$pkg}\"  ]" ; then
			eval "export \${ROCKCFG_JAILDIR_$pkg}=\"${ROCKCFG_BASEJAIL}/$pkg\""
		fi
		eval "export jail=\"\${ROCKCFG_JAILDIR_$pkg}\""

		case "$pkg" in
			# Setting destvar 
			postfix) destvar='install_root' ;;
			php) destvar='INSTALL_ROOT' ;;
			*) destvar='DESTDIR' ;;

			# Special package settings
			apache) postmake=jail_pkg_apache_postmake ;;
			postfix) postmake=jail_pkg_postfix_postmake ;;
			openldap) postmake='jail_ensure_users ldap' ;;
			mysql) var_append extraconfopt " " "--with-mysql-user=$pkg"
				inmake="jail_ensure_users mysql"
				postmake="jail_pkg_mysql_postmake" ;;
			php) has_internal='mysql' ;;
		esac

		createprefix='0'
		createdocs='0'
		hook_add prepare 7 jail_set_confopt
		hook_add preconf 1 jail_create
		hook_add inmake 9 '[ "$destvar" ] && var_append makeinstopt " " "$destvar=$root/$jail"'
		hook_add postmake 9 jail_copy_needed_libs
		var_append flistroot " " "$jail"

		echo_status "Jailing support activated to directory "'$root/'"$jail"
	fi
	hook_add preconf 6 'jail_confopt_paths_rewrite'
fi



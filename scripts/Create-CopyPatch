#!/bin/bash

copynote=`mktemp`
copynotepatch=`mktemp`
rocknote=`mktemp`
oldfile=`mktemp`
newfile=`mktemp`
tmpfile=`mktemp`

cat << EOT > $copynote
This copyright note is auto-generated by ./scripts/Create-CopyPatch.

T2 SDE: @@FILENAME@@
Copyright (C) 2004 - `date +%Y` The T2 SDE Project
@@ROCK-LINUX-COPYRIGHT@@
More information can be found in the files COPYING and README.

EOT

cp $copynote $copynotepatch

cat << EOT >> $copynote
This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; version 2 of the License. A copy of the
GNU General Public License can be found in the file COPYING.
EOT

cat << EOT >> $copynotepatch
This patch file is dual-licensed. It is available under the license the
patched project is licensed under, as long as it is an OpenSource license
as defined at http://www.opensource.org/ (e.g. BSD, X11) or under the terms
of the GNU General Public License as published by the Free Software
Foundation; either version 2 of the License, or (at your option) any later
version.
EOT

echo "Creating copy.patch (this may take a while) ..." >&2

[ $# = 0 ] && set architecture/. misc/. package/. scripts/. target/.

bash scripts/xfind.sh $* -type f ! -name "*~" \
	! -name Create-CopyPatch | sed 's,/\./,/,g' |
while read filename ; do
	# set -x; set -e
	rockcopyright=`grep 'ROCK Linux' $filename |
	               sed -n 's,.*\(Copyright (C) .*\),\1,p' |
	               sed 's/Clifford Wolf/ROCK Linux Project/' | head -n1`
	if [ -n "$rockcopyright" ]; then
		rockcopyright="${rockcopyright}\n"
	fi

	[[ $filename = *.cache ]] && continue

	# determine the comment mode first
	mode=none
	case $filename in
		*/Makefile|*.sh|*.pl|*.in|*.hlp|*.conf) mode=sh ;;
		*.cron|*.postinstall|*.init) mode=sh ;;
		*.h|*.c|*.lex|*.y|*.spec|*.tcx|*.tmpl|*.tcc) mode=c ;;
		*.desc) mode=asci ;;
		*scripts/[A-Z][a-z-]*|*/parse-config*) mode=sh ;;
		*patch|*diff|*patch.*) mode=sh ;;
		*m4) mode=m4 ;;
	esac
	[ $mode = none ] && grep -n '^#!' $filename | grep -q ':1:' &&
		mode=sh

	if [ $mode = none ] ; then
		echo "Unknown type of $filename"
		continue
	fi

	#echo "Mode type: $mode"

	grep -q -- '--- NO-\(T2\|ROCK\)-COPYRIGHT-NOTE ---' $filename &&
		continue

	tag="`grep -- '--- \(T2\|ROCK\)-COPYRIGHT-NOTE-BEGIN ---' \
	           $filename | sed 's,---.*,,' | head -n 1`"

	# make a copy in the case we have no matching conditional below
	sed 's,ROCK-COPYRIGHT-NOTE,T2-COPYRIGHT-NOTE,g' $filename > $oldfile

	# if there is no note present yet, implant a note
	if [ -z "$tag" ]; then
		case "$mode" in
			sh)
				if [ "`head -n 1 $filename | grep '^#!'`" ] ; then
					sed '1 a\
# --- T2-COPYRIGHT-NOTE-BEGIN ---\
# --- T2-COPYRIGHT-NOTE-END ---' < $filename > $oldfile
				else
					sed '1 i\
# --- T2-COPYRIGHT-NOTE-BEGIN ---\
# --- T2-COPYRIGHT-NOTE-END ---' < $filename > $oldfile
				fi
				tag="# "
				;;
			asci)
				sed '1 i\
[COPY] --- T2-COPYRIGHT-NOTE-BEGIN ---\
[COPY] --- T2-COPYRIGHT-NOTE-END ---' < $filename > $oldfile
				tag="[COPY] "
				;;
			c)
				 sed '1 i\
/*\
 * --- T2-COPYRIGHT-NOTE-BEGIN ---\
 * --- T2-COPYRIGHT-NOTE-END ---\
 */' < $filename > $oldfile
                		tag=" \* "
				;;
			m4)
				sed '1 i\
dnl --- T2-COPYRIGHT-NOTE-BEGIN ---\
dnl --- T2-COPYRIGHT-NOTE-END ---' < $filename > $oldfile

				tag="dnl "
				;;
		esac
	fi

	mangled_filename=`echo $filename | \
		sed 's,package/\([^/]*\)/\(.*\),package/.../\2,'`

	#echo BEFORE
	#cat $oldfile

	if [ "$tag" ] ; then
	    # implant T2 copy note
	    {
		grep -B 100000 -- '--- T2-COPYRIGHT-NOTE-BEGIN ---' $oldfile
		{
		if [ "$filename" != "${filename%/*.diff}" -o \
		     "$filename" != "${filename%/*.patch}" -o \
		     "$filename" != "${filename%/*.patch.*}" ] ; then
			sed -e "s,@@FILENAME@@,$mangled_filename,; \
				s,@@ROCK-LINUX-COPYRIGHT@@,$rockcopyright,;" \
				$copynotepatch
		else
			sed -e "s,@@FILENAME@@,$mangled_filename,; \
				s,@@ROCK-LINUX-COPYRIGHT@@,$rockcopyright,;" \
				$copynote
		fi
		# we need a separated sed call because $rockcopyright adds a new line
		} | sed -e "s,^,$tag,"

		grep -A 100000 -- '--- T2-COPYRIGHT-NOTE-END ---' $oldfile
	    } > $newfile

	    # create the difference
	    if ! cmp -s $oldfile $newfile ; then
		echo "Creating patch for $filename." >&2
		diff -u ./$filename $newfile |
			sed -e "2 s,$newfile,./$filename,"
	    fi
	else
		echo "WARNING: No Copyright tags in $filename found!" >&2
	fi
done

rm -f $copynote $copynotepatch $newfile


#!/bin/bash

copynote=`mktemp`
copynotepatch=`mktemp`
rocknote=`mktemp`
oldfile=`mktemp`
newfile=`mktemp`
tmpfile=`mktemp`

cat << EOT > $copynote

This copyright note is auto-generated by ./scripts/Create-CopyPatch.

T2 SDE: @@FILENAME@@
T2 SDE is Copyright (C) 2004 - `date +%Y` The T2 SDE Project

EOT

cp $copynote $copynotepatch

cat << EOT >> $copynote
This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; version 2 of the License. A copy of the
GNU General Public License can be found in the file COPYING.

Many people helped and are helping developing the T2 SDE. Please have
a look at the T2 homepage at http://www.exactcode.de/t2/ for details.

EOT

cat << EOT >> $copynotepatch
This patch file is dual-licensed. It is available under the license the
patched project is licensed under, as long as it is an OpenSource license
as defined at http://www.opensource.org/ (e.g. BSD, X11) or under the terms
of the GNU General Public License as published by the Free Software
Foundation; either version 2 of the License, or (at your option) any later
version.

EOT

cat << EOT > $rocknote

This file is based uppon ROCK Linux, licensed under the terms of the GNU
General Public License.
ROCK Linux was Copyright (C) 1998 - 2004 The ROCK Linux Project
Clifford Wolf, Rene Rebe et. al.

EOT

echo "Creating copy.patch (this may take a while) ..." >&2

[ $# = 0 ] && set Documentation/. architecture/. misc/. \
                  package/. scripts/. target/.

bash scripts/xfind.sh $* -type f ! -name "*~" \
	! -name Create-CopyPatch | sed 's,/\./,/,g' | \
while read filename
do

	# determine the comment mode first
	mode=none
	case $filename in
		*.h*|*.c*|*.lex|*.y|*.spec|*.tcx|*.tmpl|*.tcc) mode=c ;;
		*.desc|*.cache) mode=asci ;;
		*/Makefile|*.sh|*.pl|*.conf) mode=sh ;;
		*scripts/[A-Z][a-z-]*) mode=sh ;;
	esac
	[ $mode = none ] && grep -n '^#!' $filename | grep -q ':1:' &&
		mode=sh

	if [ $mode = none ] ; then
		echo "Unknown type of $filename"
		continue
	fi

	echo "Mode type: $mode"

	grep -q -- '--- NO-\[T2\|ROCK\]-COPYRIGHT-NOTE ---' $filename &&
		continue
	grep -q -- '--- ROCK-COPYRIGHT-NOTE ---' $filename &&
		rock_note_present=1 || rock_note_present=0

	tag="`grep -- '--- T2-COPYRIGHT-NOTE-BEGIN ---' \
	           $filename | sed 's,---.*,,' | head -n 1`"

	# make a copy in the case we have no matching conditional below
	cat $filename > $oldfile

	# if there is no note present yet, implant a note
	if [ -z "$tag" -a $mode = sh ] ; then
		sed '1 a\
# --- T2-COPYRIGHT-NOTE-BEGIN ---\
# --- T2-COPYRIGHT-NOTE-END ---' < $filename > $oldfile

		tag="# "
	fi

	if [ -z "$tag" -a $mode = asci ] ; then
		sed '1 i\
[COPY] --- T2-COPYRIGHT-NOTE-BEGIN ---\
[COPY] --- T2-COPYRIGHT-NOTE-END ---
' < $filename > $oldfile
		tag="[COPY] "
	fi

	if [ -z "$tag" -a $mode = c ] ; then
		sed '1 i\
/*
 * --- T2-COPYRIGHT-NOTE-BEGIN ---\
 * --- T2-COPYRIGHT-NOTE-END ---\
 */
' < $filename > $oldfile
                tag=" \* "
        fi

	mangled_filename=`echo $filename | \
		sed 's,package/\([^/]*\)/\(.*\),package/.../\2,'`

	#echo BEFORE
	#cat $oldfile

	if [ "$tag" ] ; then
	    # implant T2 copy note
	    {
		grep -B 100000 -- '--- T2-COPYRIGHT-NOTE-BEGIN ---' $oldfile
		if [ "$filename" != "${filename%/*.diff}" -o \
		     "$filename" != "${filename%/*.patch}" -o \
		     "$filename" != "${filename%/*.patch.*}" ] ; then
			cat $copynotepatch | \
			sed -e "s,@@FILENAME@@,$mangled_filename,; s,^,$tag,"
		else
			cat $copynote | \
			sed -e "s,@@FILENAME@@,$mangled_filename,; s,^,$tag,"
		fi

		grep -A 100000 -- '--- T2-COPYRIGHT-NOTE-END ---' $oldfile
	    } > $tmpfile

	    # reimplant ROCK copy note
	    {
	    if [ $rock_note_present ] ; then
		grep -B 100000 -- '--- ROCK-COPYRIGHT-NOTE-BEGIN ---' $tmpfile
		cat $rocknote | sed -e "s,^,$tag,"
                grep -A 100000 -- '--- ROCK-COPYRIGHT-NOTE-END ---' $tmpfile
	    else
		cat $tmpfile
	    fi
	    } > $newfile

	    # create the difference
	    if ! cmp -s $oldfile $newfile ; then
		echo "Creating patch for $filename." >&2
		diff -u ./$filename $newfile |
			sed -e "2 s,$newfile,./$filename,"
	    fi
	else
		echo "WARNING: No Copyright tags in $filename found!" >&2
	fi
done

rm -f $copynote $copynotepatch $newfile

